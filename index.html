<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>無線観測シミュ｜事案追跡システム</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;700&family=Roboto+Mono:wght@400;700&display=swap" rel="stylesheet">
<style>
:root{--bg:#0d1117;--panel:#161b22;--ink:#c9d1d9;--muted:#8b949e;--line:#30363d;--accent:#58a6ff;--red:#f85149;--green:#3fb950;--ops:#d29922}
*{box-sizing:border-box;margin:0;padding:0}
body{background:var(--bg);color:var(--ink);font:13px/1.5 'Roboto Mono',monospace;min-height:100vh;display:flex;flex-direction:column;text-transform:uppercase;letter-spacing:0.5px}
header{position:sticky;top:0;z-index:10;background:var(--panel);border-bottom:1px solid var(--line);padding:12px 20px}
.header-top{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;padding-bottom:10px;border-bottom:1px solid var(--line)}
.clock{font-weight:700;font-size:16px;color:var(--accent)}
.status-pill{border:1px solid var(--line);padding:4px 12px;color:var(--muted);font-size:11px;background:rgba(0,0,0,0.3)}
.controls{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
button{border:1px solid var(--line);background:rgba(88,166,255,0.1);color:var(--accent);padding:8px 16px;cursor:pointer;font-weight:600;font-size:11px;font-family:inherit;letter-spacing:1px;transition:all 0.2s}
button:hover{background:rgba(88,166,255,0.2);border-color:var(--accent)}
button.ghost{background:rgba(0,0,0,0.3);color:var(--muted)}
button.ghost:hover{background:rgba(0,0,0,0.4);color:var(--ink)}
select{border:1px solid var(--line);background:rgba(0,0,0,0.3);color:var(--ink);padding:8px 12px;font-size:11px;font-family:'Noto Sans JP',sans-serif;cursor:pointer;min-width:220px;text-transform:none}
.rate-control{display:flex;align-items:center;gap:10px;color:var(--muted);font-size:11px;padding:6px 12px;border:1px solid var(--line);background:rgba(0,0,0,0.3)}
.rate-control input[type="range"]{-webkit-appearance:none;width:120px;height:4px;background:var(--line);outline:none}
.rate-control input[type="range"]::-webkit-slider-thumb{-webkit-appearance:none;width:14px;height:14px;background:var(--accent);cursor:pointer}
.rate-control span{color:var(--accent);font-weight:700;min-width:40px}
main{flex:1;padding:16px;max-width:1600px;width:100%;margin:0 auto}
#caseStatus{border:1px solid var(--line);background:rgba(0,0,0,0.3);padding:12px;margin-bottom:12px;max-height:150px;overflow:auto}
#caseStatus h3{font-size:11px;color:var(--accent);margin-bottom:8px}
.case-item{display:grid;grid-template-columns:60px 50px 100px 80px 1fr;gap:8px;padding:4px 8px;font-size:10px;border-bottom:1px solid var(--line)}
.case-item:last-child{border-bottom:none}
.case-id{color:var(--accent);font-weight:700}
.case-unit{color:var(--ink)}
.case-phase{color:var(--muted)}
.case-zone{color:var(--ops)}
.case-time{color:var(--muted);text-align:right}
#log{border:1px solid var(--line);min-height:calc(100vh - 350px);max-height:calc(100vh - 350px);overflow:auto;padding:8px;background:#010409}
.row{padding:8px 10px;display:grid;grid-template-columns:90px 50px 70px 1fr;gap:10px;align-items:start;margin-bottom:2px;border-left:2px solid transparent}
.row:hover{background:rgba(88,166,255,0.03);border-left-color:var(--accent)}
.ts{color:var(--muted);font-size:11px;font-weight:700}
.ch{padding:3px 10px;font-weight:700;font-size:10px;border:1px solid rgba(0,0,0,0.5)}
.ch.RED{background:var(--red);color:#fff}
.ch.GREEN{background:var(--green);color:#000}
.ch.OPS{background:var(--ops);color:#000}
.case-tag{color:var(--accent);font-size:10px;font-weight:700}
.msg{white-space:pre-wrap;line-height:1.6;font-size:13px;font-family:'Noto Sans JP',sans-serif;text-transform:none}
</style>

<!-- head 内：PWAメタ -->
<link rel="manifest" href="./manifest.webmanifest">
<meta name="theme-color" content="#0d1117">

<!-- iOSでホーム追加したとき用（任意） -->
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<link rel="apple-touch-icon" href="./icons/maskable-192.png">

</head>
<body>

<header>
<div class="header-top">
<div class="clock" id="jst">--:--:--.--- JST</div>
<div class="status-pill" id="status">STANDBY</div>
</div>
<div class="controls">
<button id="syncBtn">INITIATE SYNC</button>
<button id="ttsToggle" class="ghost">VOICE: OFF</button>
<select id="voiceSel"><option value="">Auto Select</option></select>
<label class="rate-control">
RATE: <input type="range" id="rateSlider" min="0.5" max="2.0" step="0.1" value="1.5">
<span id="rateValue">1.5</span>X
</label>
</div>
</header>

<main>
<div id="caseStatus">
<h3>ACTIVE CASES</h3>
<div id="caseList">NO ACTIVE CASES</div>
</div>
<div id="log"></div>
</main>

<script>
// グローバル変数
const FIXED_SEED="kitakyu2025";
const BASE_CPS=12;
const activeCases=new Map();
let caseIdCounter=1;
let TTS_ENABLED=false;
let chosenVoice=null;
let ttsRate=1.5;
let audioCtx=null;
let clockOffset=0;
let tickTimer=null;
let noiseNode=null;
let noiseGain=null;
let runningToken=0;
const lastTexts=[];

// 事案クラス
class Case{
  constructor(id,type,zone,unit,startTime){
    this.id=id;
    this.type=type;
    this.zone=zone;
    this.units=[unit];
    this.startTime=startTime;
    this.phase='dispatch';
    this.needsBackup=false;
    this.awaitingResponse=true; // 応答待ちフラグ
  }
  advancePhase(newPhase){
    this.phase=newPhase;
    if(newPhase!=='dispatch'&&newPhase!=='backup_response'){
      this.awaitingResponse=false;
    }
  }
  addUnit(unit){
    if(!this.units.includes(unit)){
      this.units.push(unit);
      this.awaitingResponse=true; // 新しいユニットの応答待ち
    }
  }
  getElapsedTime(){return Math.floor((Date.now()-this.startTime)/1000);}
  getStatus(){
    const map={dispatch:'出動指令',enroute:'現場向け',on_scene:'現場対応中',backup:'応援要請',clear:'処理完了'};
    return map[this.phase]||this.phase;
  }
}

// ユーティリティ
function strHash32(s){let h=2166136261>>>0;for(let i=0;i<s.length;i++){h^=s.charCodeAt(i);h=Math.imul(h,16777619)}return h>>>0;}
function mulberry32(seed){let t=seed>>>0;return()=>{t+=0x6D2B79F5;let x=Math.imul(t^t>>>15,1|t);x^=x+Math.imul(x^x>>>7,61|x);return((x^x>>>14)>>>0)/4294967296;};}
const rand01=(seed,...k)=>mulberry32(strHash32([seed,...k].join("|")))();
const sleep=ms=>new Promise(r=>setTimeout(r,ms));
function qms(ms,q=10){return Math.max(q,Math.round(ms/q)*q);}

// データ
const TYPES=[
  {key:"traffic_accident",ja:"交通事故",ch:"RED",unitType:"traffic"},
  {key:"theft",ja:"窃盗事件",ch:"RED",unitType:"investigation"},
  {key:"suspicious",ja:"不審車両",ch:"OPS",unitType:"patrol"},
  {key:"traffic_violation",ja:"交通違反",ch:"GREEN",unitType:"traffic"}
];
const ZONES=["1丁目","2丁目","3丁目","みなと通り","幹線12号","湾岸23号"];

// ユニットタイプ別の番号
const UNIT_TYPES={
  investigation:["捜査301","捜査302","捜査303"], // 事件
  traffic:["交機201","交機202","交機203","交機204"], // 事故・交通違反
  patrol:["遊撃101","遊撃102","遊撃103"], // 不審者
  backup:["201","202","203","204","205"] // 応援（無印）
};
const PHRASES={
  dispatch:["警視庁から{unit}、{zone}、{type_ja}の110番通報。至急現場へ転進せよ。","{zone}付近、{type_ja}。{unit}、対応願いたい。"],
  enroute:["{unit}から本部、{zone}へ向かっております。到着予定{eta}分。","{unit}了解。{zone}方向へ移動中。"],
  on_scene:["{unit}から本部、現着しました。状況確認中。","{unit}、現場到着。特徴一致の車両を発見。"],
  backup:["{unit}から本部、{zone}にて応援要請。至急支援願いたい。","本部から各車、{zone}で{type_ja}、応援求む。"],
  backup_response:["本部から{unit}、{zone}、応援要請あり。至急現場へ転進せよ。","{unit}、{zone}へ応援に向かえ。"],
  clear:["{unit}から本部、処理完了。巡回密航へ戻ります。","{unit}、事案処理終了。"]
};

function updateCaseStatus(){
  const el=document.getElementById("caseList");
  const active=Array.from(activeCases.values()).filter(c=>c.phase!=='clear');
  if(active.length===0){
    el.innerHTML='<div style="color:var(--muted);font-size:10px;padding:8px;">NO ACTIVE CASES</div>';
    return;
  }
  el.innerHTML=active.map(c=>{
    const t=c.getElapsedTime();
    const m=Math.floor(t/60),s=t%60;
    const unitsStr=c.units.join(',');
    return`<div class="case-item"><span class="case-id">${c.id}</span><span class="case-unit">${unitsStr}</span><span class="case-phase">${c.getStatus()}</span><span class="case-zone">${c.zone}</span><span class="case-time">${m}:${String(s).padStart(2,'0')}</span></div>`;
  }).join('');
}

function genMessage(seed,n){
  const t=TYPES[(rand01(seed,"type",n)*TYPES.length)|0];
  const zone=ZONES[(rand01(seed,"zone",n)*ZONES.length)|0];
  
  // 全ユニットのリスト
  const allUnits=[...UNIT_TYPES.investigation,...UNIT_TYPES.traffic,...UNIT_TYPES.patrol,...UNIT_TYPES.backup];
  
  // 稼働中のユニットを除外
  const busyUnits=new Set();
  for(let[id,c]of activeCases){
    if(c.phase!=='clear'){
      c.units.forEach(u=>busyUnits.add(u));
    }
  }
  
  // 事案タイプに応じた利用可能なユニット
  const getAvailableUnits=(unitType)=>{
    return UNIT_TYPES[unitType].filter(u=>!busyUnits.has(u));
  };
  
  let existingCase=null;
  let unit=null;
  let phase,caseId;
  
  // 最優先：応答待ちの事案があるか確認
  for(let[id,c]of activeCases){
    if(c.awaitingResponse){
      existingCase=c;
      unit=c.units[c.units.length-1];
      
      if(c.phase==='dispatch'){
        phase='enroute';
        c.advancePhase(phase);
      }else if(c.phase==='backup_response'){
        phase='enroute';
        c.advancePhase('on_scene');
      }
      break;
    }
  }
  
  // 応答待ちがない場合、通常のフロー
  if(!existingCase){
    for(let[id,c]of activeCases){
      if(c.phase!=='clear'){
        if(rand01(seed,"continue",n)>0.2){
          existingCase=c;
          unit=c.units[0];
          break;
        }
      }
    }
  }
  
  // 既存事案を進める
  if(existingCase&&!phase){
    caseId=existingCase.id;
    
    // 現場対応中の場合、20%の確率で応援要請
    if(existingCase.phase==='on_scene'&&!existingCase.needsBackup&&rand01(seed,"backup",n)<0.2){
      phase='backup';
      existingCase.needsBackup=true;
      existingCase.advancePhase(phase);
    }
    // 応援要請後、応援ユニット（無印）を派遣
    else if(existingCase.phase==='backup'){
      const availableBackup=getAvailableUnits('backup');
      if(availableBackup.length>0){
        phase='backup_response';
        unit=availableBackup[0];
        existingCase.addUnit(unit);
        existingCase.advancePhase('backup_response');
      }else{
        // 応援ユニットがいない場合は通常進行
        phase='on_scene';
        existingCase.advancePhase(phase);
      }
    }
    // 通常のフェーズ進行
    else{
      const next={enroute:'on_scene',on_scene:'clear',backup:'on_scene'};
      phase=next[existingCase.phase]||'clear';
      existingCase.advancePhase(phase);
      if(phase==='clear')setTimeout(()=>activeCases.delete(caseId),3000);
    }
  }
  // 新規事案
  else if(!existingCase){
    const availableForType=getAvailableUnits(t.unitType);
    if(availableForType.length===0){
      // 該当タイプのユニットがいない場合はランダム
      const allAvailable=allUnits.filter(u=>!busyUnits.has(u));
      if(allAvailable.length>0){
        unit=allAvailable[(rand01(seed,"unit",n)*allAvailable.length)|0];
      }else{
        unit=allUnits[(rand01(seed,"unit",n)*allUnits.length)|0];
      }
    }else{
      unit=availableForType[(rand01(seed,"unit",n)*availableForType.length)|0];
    }
    caseId=`C${String(caseIdCounter++).padStart(4,'0')}`;
    phase='dispatch';
    activeCases.set(caseId,new Case(caseId,t.key,zone,unit,Date.now()));
  }else{
    caseId=existingCase.id;
  }
  
  const set=PHRASES[phase]||["{unit}から本部、報告願います。"];
  const tpl=set[Math.floor(rand01(seed,"tpl",n)*set.length)];
  const eta=2+Math.floor(rand01(seed,"eta",n)*8);
  const num=1+Math.floor(rand01(seed,"num",n)*3);
  const msg=tpl.replace("{zone}",zone).replace("{type_ja}",t.ja).replace("{unit}",unit).replace("{eta}",eta).replace("{num}",num);
  return{id:`N${String(n).padStart(6,"0")}`,caseId,ch:t.ch,phase,zone,unit,msg};
}

function charClass(ch){const c=ch.codePointAt(0);if(c<=0x7F)return"ascii";if(c>=0x3040&&c<=0x309F)return"hira";if(c>=0x30A0&&c<=0x30FF)return"kata";if((c>=0x4E00&&c<=0x9FFF)||(c>=0x3400&&c<=0x4DBF))return"kanji";return"other";}
async function typeOut(seed,cpsBase,ev,msgEl){
  const weights={hira:1.0,kata:1.0,ascii:0.9,kanji:1.15,other:1.0};
  const pauses={",":120,"、":160,".":180,"。":220," ":50};
  const r=rand01(seed,"speed",ev.id),cps=cpsBase*(1-0.15+2*0.15*r),base=1000/cps;
  msgEl.textContent="";
  for(let i=0;i<ev.msg.length;i++){
    const ch=ev.msg[i],w=weights[charClass(ch)]??1.0;
    let extra=pauses[ch]?pauses[ch]*(0.9+0.2*rand01(seed,"pause",ev.id,i)):0;
    await sleep(qms(base*w+extra,10));
    msgEl.textContent+=ch;
  }
}

function gapMs(seed,nextIndex){const base=1800;return Math.max(800,Math.min(3800,Math.round(base*(0.6+0.8*rand01(seed,"gap",nextIndex)))));}
async function getClockOffsetMs(){try{const t0=performance.now();const res=await fetch(location.href,{method:"HEAD",cache:"no-store"});const srv=Date.parse(res.headers.get("Date"));const t1=performance.now();return(srv+(t1-t0)/2)-Date.now();}catch{return 0;}}

// 時計
(function(){
  const el=document.getElementById("jst");
  function pad(n,len=2){return String(n).padStart(len,"0");}
  function tick(){
    const now=new Date();
    const y=now.getFullYear(),m=now.getMonth()+1,d=now.getDate();
    el.textContent=`${y}/${pad(m)}/${pad(d)} ${pad(now.getHours())}:${pad(now.getMinutes())}:${pad(now.getSeconds())}.${pad(now.getMilliseconds(),3)} JST`;
  }
  tick();setInterval(tick,33);
})();

// 音声
function ensureAudio(){
  if(!audioCtx)
    audioCtx = new (window.AudioContext || window.webkitAudioContext)();
  if(audioCtx.state === "suspended")
    audioCtx.resume();
}

function toneNTT(kind){
  if(!audioCtx) return;
  const p = {
    pip:  { f:2000, dur:40,  g:0.03, atk:0.004, dec:0.030, rel:0.030, h2:0.18 },
    pop:  { f:500,  dur:100, g:0.06,  atk:0.006, dec:0.050, rel:0.060, h2:0.20 },
    peen: { f:1000, dur:600, g:0.06,  atk:0.008, dec:0.200, rel:0.300, h2:0.25 }
  }[kind];

  const ctx = audioCtx, t0 = ctx.currentTime;
  const osc = ctx.createOscillator(); osc.type = 'square'; osc.frequency.value = p.f;
  const gain = ctx.createGain(); gain.gain.value = 0;
  const filter = ctx.createBiquadFilter(); filter.type = 'lowpass'; filter.frequency.value = p.f * 1.4;
  osc.connect(filter); filter.connect(gain); gain.connect(ctx.destination);

  const g = gain.gain;
  const t1 = t0 + p.atk;                      // Attack
  const t2 = t1 + p.dec;                      // Decay
  const t3 = t0 + (p.dur / 1000) * 0.7;       // Sustain (約70%)
  const t4 = t0 + (p.dur / 1000);             // Release開始
  const t5 = t4 + p.rel;                      // 終了

  g.setValueAtTime(0, t0);
  g.linearRampToValueAtTime(p.g, t1);         // Attack上昇
  g.linearRampToValueAtTime(p.g * 0.8, t2);   // Decay減衰
  g.setValueAtTime(p.g * 0.8, t3);            // Sustain維持
  g.linearRampToValueAtTime(0.0001, t5);      // Releaseフェードアウト

  osc.start(t0);
  osc.stop(t5 + 0.05);
}

function startTimeSignal(){
  if(tickTimer) clearInterval(tickTimer);
  tickTimer = setInterval(()=>{
    const now = Date.now() + clockOffset;
    if(now % 1000 >= 8) return;
    const s = Math.floor(now / 1000) % 60;
    if(s % 10 === 0){ toneNTT('peen'); return; }
    if(s === 27 || s === 28 || s === 29 || s === 57 || s === 58 || s === 59){ toneNTT('pop'); return; }
    toneNTT('pip');
  },4);
}


function startWhiteNoise(){
  if(!audioCtx||noiseNode)return;
  const bufferSize=2*audioCtx.sampleRate;
  const noiseBuffer=audioCtx.createBuffer(1,bufferSize,audioCtx.sampleRate);
  const output=noiseBuffer.getChannelData(0);
  for(let i=0;i<bufferSize;i++)output[i]=Math.random()*2-1;
  noiseNode=audioCtx.createBufferSource();noiseNode.buffer=noiseBuffer;noiseNode.loop=true;
  noiseGain=audioCtx.createGain();noiseGain.gain.value=0.015;
  const hp=audioCtx.createBiquadFilter();hp.type='highpass';hp.frequency.value=800;
  const lp=audioCtx.createBiquadFilter();lp.type='lowpass';lp.frequency.value=3000;
  noiseNode.connect(noiseGain);noiseGain.connect(hp);hp.connect(lp);lp.connect(audioCtx.destination);
  noiseNode.start();
}
function stopWhiteNoise(){
  if(noiseNode){noiseNode.stop();noiseNode.disconnect();noiseNode=null;}
  if(noiseGain){noiseGain.disconnect();noiseGain=null;}
}

function playTransmitStart(){
  if(!audioCtx)return;
  const ctx=audioCtx,t0=ctx.currentTime;
  const osc=ctx.createOscillator();osc.type='square';osc.frequency.value=1400;
  const gain=ctx.createGain();gain.gain.value=0;
  const filter=ctx.createBiquadFilter();filter.type='lowpass';filter.frequency.value=2800;
  osc.connect(filter);filter.connect(gain);gain.connect(ctx.destination);
  gain.gain.setValueAtTime(0,t0);gain.gain.linearRampToValueAtTime(0.35,t0+0.003);gain.gain.exponentialRampToValueAtTime(0.001,t0+0.12);
  osc.start(t0);osc.stop(t0+0.15);
}

function playTransmitEnd(){
  if(!audioCtx)return;
  const ctx=audioCtx,t0=ctx.currentTime;
  [1100,950,800].forEach((f,i)=>{
    const osc=ctx.createOscillator();osc.type='square';osc.frequency.value=f;
    const gain=ctx.createGain();gain.gain.value=0;
    const filter=ctx.createBiquadFilter();filter.type='lowpass';filter.frequency.value=f*2;
    osc.connect(filter);filter.connect(gain);gain.connect(ctx.destination);
    const t=t0+i*0.07;
    gain.gain.setValueAtTime(0,t);gain.gain.linearRampToValueAtTime(0.30,t+0.003);gain.gain.exponentialRampToValueAtTime(0.001,t+0.1);
    osc.start(t);osc.stop(t+0.12);
  });
}

// TTS
function pickJaVoice(){
  const vs=window.speechSynthesis?.getVoices?.()||[];
  let cand=vs.filter(v=>/^ja/i.test(v.lang));
  if(cand.length===0)cand=vs.filter(v=>/JP|Japanese/i.test(v.name));
  return cand[0]||vs[0]||null;
}
function loadVoices(){
  if(!('speechSynthesis'in window))return;
  const load=()=>{
    const vs=speechSynthesis.getVoices();
    const sel=document.getElementById("voiceSel");
    sel.innerHTML='<option value="">Auto Select</option>';
    vs.forEach((v,i)=>{
      const o=document.createElement('option');
      o.value=String(i);o.textContent=`${v.name} (${v.lang})`;
      sel.appendChild(o);
    });
    chosenVoice=pickJaVoice();
  };
  load();
  speechSynthesis.onvoiceschanged=load;
}
loadVoices();

document.getElementById("voiceSel").addEventListener('change',()=>{
  const vs=speechSynthesis.getVoices();
  const i=parseInt(document.getElementById("voiceSel").value);
  chosenVoice=Number.isInteger(i)?vs[i]:pickJaVoice();
});

document.getElementById("rateSlider").addEventListener('input',()=>{
  ttsRate=parseFloat(document.getElementById("rateSlider").value);
  document.getElementById("rateValue").textContent=ttsRate.toFixed(1);
});

// --- PATCH START (iPad TTS: speakAndHighlight replacement) ---
async function speakAndHighlight(ev, msgEl, seed, cpsBase){
  if(!('speechSynthesis' in window)) return Promise.resolve();

  ensureAudio();
  const typePromise = typeOut(seed, cpsBase, ev, msgEl);

  // iPad/SafariはTTSとWebAudioの同時再生で無音化しやすい → 先に一時停止
  let suspended = false;
  if(isiOS() && audioCtx && audioCtx.state === 'running'){
    await audioCtx.suspend();
    suspended = true;
  }

  // iOSは同時再生を避けるためビープ/ノイズを鳴らさない
  if(!isiOS()){
    playTransmitStart();
    setTimeout(()=>startWhiteNoise(), 100);
  }

  const utter = new SpeechSynthesisUtterance(ev.msg);
  utter.lang   = (chosenVoice?.lang) || 'ja-JP';
  utter.voice  = chosenVoice || null;             // nullでもOK（既定声）
  utter.rate   = isiOS() ? Math.min(ttsRate, 1.2) : ttsRate; // iOSは速すぎると無音化しやすい
  utter.pitch  = 1.0;
  utter.volume = 1.0;

  const speakPromise = new Promise((resolve)=>{
    const cleanup = async ()=>{
      if(!isiOS()){ stopWhiteNoise(); playTransmitEnd(); }
      if(suspended && audioCtx?.state === 'suspended'){
        try{ await audioCtx.resume(); }catch{}
      }
      resolve();
    };
    utter.onend   = cleanup;
    utter.onerror = cleanup;

    // 直前の発話だけを止める（直後の speak を潰さない）
    try{
      if(speechSynthesis.speaking || speechSynthesis.pending){
        speechSynthesis.cancel();
      }
    }catch{}

    // iOSで cancel 直後の speak が潰れる件の回避：0ms遅延で次フレームに投げる
    setTimeout(()=>{ try{ speechSynthesis.speak(utter); }catch{ cleanup(); } }, 0);
  });

  return Promise.all([typePromise, speakPromise]);
}
// --- PATCH END ---


// メインループ
async function runFromNow(seed,cpsBase){
  const status=document.getElementById("status"),log=document.getElementById("log");
  const my=++runningToken;
  lastTexts.length=0;
  log.innerHTML="";
  activeCases.clear();
  caseIdCounter=1;
  status.textContent="ACTIVE";
  try{if('speechSynthesis'in window)speechSynthesis.cancel();}catch{}
  let n=0;
  let currentJstMs=Date.now()+clockOffset;
  const caseInterval=setInterval(()=>{
    if(my!==runningToken){clearInterval(caseInterval);return;}
    updateCaseStatus();
  },1000);
  while(my===runningToken){
    const ev=genMessage(seed,n);
    const row=document.createElement("div");
    row.className="row";
    const ts=document.createElement("div");
    ts.className="ts";
    const displayTime=new Date(currentJstMs);
    ts.textContent=displayTime.toLocaleTimeString("ja-JP",{hour12:false,hour:'2-digit',minute:'2-digit',second:'2-digit'});
    const ch=document.createElement("div");
    ch.className=`ch ${ev.ch}`;
    ch.textContent=ev.ch;
    const caseTag=document.createElement("div");
    caseTag.className="case-tag";
    caseTag.textContent=ev.caseId;
    const msg=document.createElement("div");
    msg.className="msg";
    row.append(ts,ch,caseTag,msg);
    log.appendChild(row);
    log.scrollTop=log.scrollHeight;
    const startTime=performance.now();
    if(TTS_ENABLED&&'speechSynthesis'in window){
      await speakAndHighlight(ev,msg,seed,cpsBase);
    }else{
      await typeOut(seed,cpsBase,ev,msg);
    }
    const elapsedMs=performance.now()-startTime;
    if(my!==runningToken){clearInterval(caseInterval);break;}
    const gap=gapMs(seed,n+1);
    await sleep(gap);
    if(my!==runningToken){clearInterval(caseInterval);break;}
    currentJstMs+=elapsedMs+gap;
    n++;
    const nextTime=new Date(currentJstMs);
    status.textContent=`MSG:${String(n).padStart(4,'0')} NEXT:${nextTime.toLocaleTimeString("ja-JP",{hour12:false,hour:'2-digit',minute:'2-digit',second:'2-digit'})}`;
  }
}

// イベントリスナー
document.getElementById("syncBtn").addEventListener("click", async ()=>{
  console.log("Button clicked!");
  ensureAudio();
  await initTTS();                       // ★ 追加
  clockOffset = await getClockOffsetMs();
  startTimeSignal();
  runFromNow(FIXED_SEED, BASE_CPS);
});

document.getElementById("ttsToggle").addEventListener("click", async ()=>{
  await initTTS();                       // ★ 追加
  TTS_ENABLED = !TTS_ENABLED;
  const btn = document.getElementById("ttsToggle");
  btn.textContent = `VOICE: ${TTS_ENABLED ? "ON" : "OFF"}`;
  btn.className = TTS_ENABLED ? "" : "ghost";
  try{ if('speechSynthesis' in window) speechSynthesis.cancel(); }catch{}
});

console.log("Script loaded successfully!");

// --- PATCH START (iPad TTS) ---
let ttsReady = false;

function isiOS(){
  return /iPad|iPhone|iPod/.test(navigator.userAgent) ||
         (navigator.platform === 'MacIntel' && navigator.maxTouchPoints > 1);
}

// iOS/Safariで getVoices が空・TTSが無音化するのを回避
async function initTTS(){
  if (ttsReady || !('speechSynthesis' in window)) return;
  await new Promise((resolve)=>{
    const u = new SpeechSynthesisUtterance(' ');
    u.volume = 0;                 // 無音で1回だけ話す＝TTSをウォームアップ
    u.onend = () => { ttsReady = true; loadVoices(); resolve(); };
    try { speechSynthesis.speak(u); } catch { resolve(); }
  });
}
// --- PATCH END ---

if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => {
    navigator.serviceWorker.register('./sw.js').catch(console.error);
  });
}

</script>
</body>
</html>