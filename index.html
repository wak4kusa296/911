<!doctype html>
<html lang="ja">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>é€šä¿¡æŒ‡ä»¤ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿</title>
  <meta name="theme-color" content="#1a1a1a">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="æŒ‡ä»¤ã‚·ã‚¹ãƒ†ãƒ ">
  <link rel="manifest" href="manifest.json">
  <link rel="apple-touch-icon" href="icon-192.png">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Barlow+Condensed:wght@600&family=Kosugi&family=M+PLUS+1p:wght@300;500;700&display=swap" rel="stylesheet">
  <style>
    @font-face {
      font-family: 'DSEG7';
      src: url('DSEG7ClassicMini-Bold.woff') format('woff');
    }

    :root {
      --bg-primary: #1a1a1a;
      --bg-secondary: #242424;
      --bg-tertiary: #2e2e2e;
      --border: #3a3a3a;
      --text-primary: #e0e0e0;
      --text-secondary: #a0a0a0;
      --text-muted: #707070;
      --accent-blue: #e0e0e0;
      --accent-cyan: #e0e0e0;
      --lv1: #4caf50;
      --lv2: #ff9800;
      --lv3: #f44336;
      --lv4: #9c27b0;
    }

    html,
    body {
      height: 100%;
      margin: 0;
      overflow: hidden;
    }

    * {
      box-sizing: border-box
    }

    body {
      background: var(--bg-primary);
      color: var(--text-primary);
      font: 14px/1.6 'M PLUS 1p', sans-serif;
      display: grid;
      font-weight: 500;
      grid-template-rows: auto auto 1fr;
    }

    .system-header {
      background: var(--bg-secondary);
      border-bottom: 2px solid var(--border);
      padding: 16px 24px;
    }

    .header-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 12px; /* â–¼â–¼â–¼ã€å¤‰æ›´ã€‘gapã‚’å°‘ã—ç‹­ãèª¿æ•´ â–¼â–¼â–¼ */
      flex-wrap: wrap;
    }

    .system-title {
      font-size: 18px;
      font-weight: 500;
      color: var(--accent-cyan);
      letter-spacing: 1px;
      text-transform: uppercase;
      margin-right: auto; /* â–¼â–¼â–¼ã€è¿½åŠ ã€‘ã‚¿ã‚¤ãƒˆãƒ«ã‚’å·¦å¯„ã›ã«ä¿ã¤ â–¼â–¼â–¼ */
    }

    .system-clock {
      font-weight: 500;
      color: var(--accent-cyan);
      font-family: 'DSEG7', monospace;
      letter-spacing: 0.5px;
      width: 100%;
      font-size: 5cqw;
      text-align: center;
      padding: 36px;
    }

    .system-status {
      display: none;
    }

    .control-panel {
      width: 100%;
      background: var(--bg-secondary);
      border-bottom: 1px solid var(--border);
      padding: 12px 24px;
      transition: all 0.3s ease-in-out;
      overflow: hidden; /* â–¼â–¼â–¼ã€è¿½åŠ ã€‘é«˜ã•ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã®ãŸã‚ â–¼â–¼â–¼ */
    }

    /* â–¼â–¼â–¼ã€å¤‰æ›´ã€‘ã‚¯ãƒ©ã‚¹åã‚’ is-open ã«å¤‰æ›´ã—ã€éè¡¨ç¤ºçŠ¶æ…‹ã‚’ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã« â–¼â–¼â–¼ */
    .control-panel:not(.is-open) {
      height: 0;
      padding-top: 0;
      padding-bottom: 0;
      border: none;
    }

    .control-row {
      display: flex;
      align-items: center;
      gap: 12px;
      flex-wrap: wrap;
      width: 100%;
    }

    .btn {
      padding: 8px 20px;
      background: var(--bg-tertiary);
      border: 1px solid var(--border);
      border-radius: 4px;
      color: var(--text-primary);
      font: 12px/1.4 'Kosugi', 'M PLUS 1p', sans-serif;
      font-weight: 300;
      cursor: pointer;
      transition: all 0.2s;
      letter-spacing: 0.5px;
      text-transform: uppercase;
      white-space: nowrap; /* â–¼â–¼â–¼ã€è¿½åŠ ã€‘ãƒœã‚¿ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã®æ”¹è¡Œã‚’é˜²ã â–¼â–¼â–¼ */
    }

    .btn:hover {
      background: var(--bg-primary);
      border-color: var(--accent-blue);
      color: var(--accent-blue);
    }

    .btn.primary {
      background: var(--accent-blue);
      border-color: var(--accent-blue);
      color: #000;
      font-weight: 500;
    }

    .btn.active {
      background: var(--accent-cyan);
      border-color: var(--accent-cyan);
      color: #000;
      font-weight: 500;
    }

    #closeControlsBtn {
      display: none;
    }

    .commander-input {
      padding: 8px 12px;
      background: var(--bg-tertiary);
      border: 1px solid var(--border);
      border-radius: 4px;
      color: var(--text-primary);
      font: 12px/1.4 'Kosugi', 'M PLUS 1p', sans-serif;
      min-width: 160px;
      height: 34px;
      flex-grow: 5;
    }

    .commander-input:focus {
      outline: none;
      border-color: var(--accent-blue);
    }

    .setting-lavel{
      width: 100%;
    }

    select {
      padding: 8px 12px;
      background: var(--bg-tertiary);
      border: 1px solid var(--border);
      border-radius: 4px;
      color: var(--text-primary);
      font: 12px/1.4 'Kosugi', 'M PLUS 1p', sans-serif;
      cursor: pointer;
      min-width: 200px;
      width: 100%;
    }

    .rate-slider.disabled,
    select.disabled {
      opacity: 0.4;
      pointer-events: none;
      cursor: not-allowed;
    }

    .main-content {
      display: grid;
      grid-template-columns: 400px 1fr;
      gap: 0;
      overflow: hidden;
      height: 100%;
    }

    .case-panel {
      background: var(--bg-secondary);
      border-right: 2px solid var(--border);
      display: flex;
      flex-direction: column;
      min-height: 0;
      height: 100%;
    }

    .panel-header {
      padding: 16px 20px;
      border-bottom: 1px solid var(--border);
      background: var(--bg-tertiary);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .panel-title {
      font-size: 13px;
      font-weight: 500;
      color: var(--accent-cyan);
      letter-spacing: 1px;
      text-transform: uppercase;
    }

    .rate-slider {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 8px 16px;
      background: var(--bg-tertiary);
      border: 1px solid var(--border);
      border-radius: 4px;
      flex-grow: 1;
      flex-wrap: wrap;
    }

    .rate-slider label {
      font-size: 11px;
      color: var(--text-muted);
      letter-spacing: 0.5px;
    }

    .rate-slider input[type="range"] {
      -webkit-appearance: none;
      appearance: none;
      width: 100px;
      height: 4px;
      background: var(--border);
      outline: none;
      border-radius: 2px;
      flex-grow: 1;
    }

    .rate-slider input[type="range"]::-webkit-slider-thumb {
      -webkit-appearance: none;
      appearance: none;
      width: 16px;
      height: 16px;
      background: var(--accent-blue);
      border-radius: 50%;
      cursor: pointer;
    }

    .rate-slider .value {
      font-weight: 500;
      color: var(--accent-blue);
      min-width: 35px;
      text-align: right;
    }
    .case-list { flex: 1; overflow-y: auto; overflow-x: hidden; padding: 20px; }
    .case-card { border-bottom: 1px solid var(--border); transition: background 0.2s; padding-bottom: 10px; margin-bottom: 20px; }
    .case-header { display: flex; align-items: center; gap: 10px; margin-bottom: 8px; }
    .level-badge { padding: 4px 10px; border-radius: 3px; font-size: 11px; font-weight: 500; letter-spacing: 0.5px; }
    .level-badge.lv1 { background: var(--lv1); color: #000; }
    .level-badge.lv2 { background: var(--lv2); color: #000; }
    .level-badge.lv3 { background: var(--lv3); color: #fff; }
    .level-badge.lv4 { background: var(--lv4); color: #fff; }
    .case-id { font-size: 13px; font-weight: 500; color: var(--accent-blue); }
    .case-type { font-size: 12px; color: var(--text-primary); margin-left: auto; }
    .case-body { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; font-size: 11px; color: var(--text-secondary); }
    .case-info-row { display: flex; gap: 6px; }
    .info-label { color: var(--text-muted); }
    .info-value { color: var(--text-secondary); font-weight: 300; }
    .case-footer { margin-top: 8px; padding-top: 8px; border-top: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; font-size: 11px; }
    .case-units { color: var(--accent-cyan); font-weight: 300; }
    .case-time { color: var(--text-muted); font-family: 'DSEG7', sans-serif; }
    .msg-time { color: var(--text-muted); font-family: 'DSEG7', sans-serif; }
    .radio-panel { background: var(--bg-primary); display: flex; flex-direction: column; min-height: 0; }
    .radio-log { flex: 1; overflow-y: auto; overflow-x: hidden; padding: 12px; padding-bottom: 40px; }
    .radio-message { display: flex; flex-direction: column; gap: 6px; padding: 12px 16px; margin-bottom: 8px; background: var(--bg-secondary); border-left: 3px solid transparent; border-radius: 4px; transition: all 0.2s; opacity: 0; transform: translateY(10px); animation: slideIn 0.3s ease-out forwards; }
    .radio-message.alert { background: repeating-linear-gradient( -45deg, rgba(33, 33, 33, 0.6), rgba(33, 33, 33, 0.6) 12px, var(--bg-secondary) 12px, var(--bg-secondary) 24px ); border-left-color: #ff3b3b; border-left-width: 4px; }
    .radio-message.alert .msg-content { text-shadow: 1px 1px 3px rgba(0,0,0,0.7); }
    @keyframes slideIn { to { opacity: 1; transform: translateY(0); } }
    .radio-message-meta { display: flex; align-items: center; gap: 10px; flex-wrap: wrap; }
    .msg-level { padding: 4px 8px; border-radius: 3px; font-size: 11px; font-weight: 500; text-align: center; letter-spacing: 0.5px; color: var(--text-muted); }
    .msg-case { font-size: 11px; font-weight: 500; color: var(--text-muted); }
    .msg-content { font: 13px/1.7 'Kosugi', 'M PLUS 1p', sans-serif; font-weight: 500; color: var(--text-primary); word-break: break-word; padding-top: 4px; }
    .no-cases { padding: 40px 20px; text-align: center; color: var(--text-muted); font-size: 12px; }
    ::-webkit-scrollbar { width: 8px; height: 8px; }
    ::-webkit-scrollbar-track { background: var(--bg-primary); }
    ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 4px; }
    ::-webkit-scrollbar-thumb:hover { background: var(--text-muted); }

    @media (max-width: 768px) {
      .main-content {
        grid-template-columns: 1fr;
        grid-template-rows: auto 1fr;
      }

      .case-panel {
        border-right: none;
        border-bottom: 2px solid var(--border);
        max-height: 25dvh;
      }
      .system-title {
        width: 100%;
        font-size: 6cqw;
        text-align: center;
      }

      /* â–¼â–¼â–¼ã€ã“ã“ã‹ã‚‰ãƒ¢ãƒã‚¤ãƒ«ç”¨ã®ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ã‚¹ã‚¿ã‚¤ãƒ«ã€‘â–¼â–¼â–¼ */
      
      /* â–¼â–¼â–¼ ãƒ¡ãƒ‡ã‚£ã‚¢ã‚¯ã‚¨ãƒªå†…ã«è¿½åŠ  â–¼â–¼â–¼ */
      #closeControlsBtn {
        display: block;
        width: 100%;
        margin-top: 24px;
        border-color: var(--text-muted);
      }
      
      .rate-slider .value {
        width: 100%;
     }

      .control-panel {
        /* ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ã®åŸºæœ¬è¨­å®š */
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(26, 26, 26, 0.95);
        backdrop-filter: blur(4px);
        /* è­¦å ±ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ã‚ˆã‚Šæ‰‹å‰ã«è¡¨ç¤º */
        z-index: 10000; 
        
        /* â–¼â–¼â–¼ã€å¤‰æ›´ã€‘ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«å¯èƒ½ã«ã—ã¤ã¤ä¸­å¤®æƒãˆã‚’ç¶­æŒ â–¼â–¼â–¼ */
        display: flex;
        align-items: flex-start; /* centerã‹ã‚‰flex-startã«å¤‰æ›´ */
        justify-content: center;
        padding: 24px;
        overflow-y: auto;
        overflow-x: hidden;
        /* â–²â–²â–²ã€å¤‰æ›´ã€‘ã“ã“ã¾ã§ â–²â–²â–² */

        /* è¡¨ç¤º/éè¡¨ç¤ºã®ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³è¨­å®š */
        opacity: 0;
        transform: scale(1.05);
        pointer-events: none;
        transition: opacity 0.2s ease-out, transform 0.2s ease-out;
      }
            
      /* is-openã‚¯ãƒ©ã‚¹ãŒä»˜ã„ãŸæ™‚ã«è¡¨ç¤ºã™ã‚‹ */
      .control-panel.is-open {
        opacity: 1;
        transform: scale(1);
        pointer-events: auto;
      }

      .control-row {
        flex-direction: column;
        align-items: stretch;
        max-width: 400px; /* ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤å†…ã§ã®æœ€å¤§å¹… */
      }

      .commander-input,
      select,
      .rate-slider {
        min-width: 0;
        width: 100%;
      }
      
      .btn {
        flex-grow: 1;
      }
      /* â–²â–²â–²ã€ã“ã“ã¾ã§ã€‘â–²â–²â–² */
      .system-clock {
        font-weight: 500;
        color: var(--accent-cyan);
        font-family: 'DSEG7', monospace;
        letter-spacing: 0.5px;
        width: 100%;
        font-size: 10cqw;
        text-align: center;
        padding: 0px;
      }

    }

    /* --- Emergency Overlay Styles (å¤‰æ›´ãªã—) --- */
    #emergency-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.7); display: flex; justify-content: center; align-items: center; z-index: 9999; text-align: center; opacity: 0; pointer-events: none; transition: opacity 0.1s ease-in-out; backdrop-filter: blur(5px); }
    #emergency-overlay.active { opacity: 1; pointer-events: auto; }
    .emergency-text-wrapper { max-width: 95%; animation: sawtooth-fade 0.5s linear infinite; }
    .emergency-title { background-color: #ff3b3b; color: #1a1a1a; font-family: 'Barlow Condensed', sans-serif; font-weight: 600; font-size: clamp(16px, 3.5vw, 2rem); letter-spacing: 0.05em; text-transform: uppercase; padding: 0.6rem 1.5rem; margin-bottom: 1rem; white-space: nowrap; }
    .emergency-subtitle { color: #ff3b3b; text-shadow: 0 0 8px rgba(255, 59, 59, 0.8); font-size: clamp(14px, 2.5vw, 1.2rem); font-weight: 500; letter-spacing: 0.2em; white-space: nowrap; }
    .stripe-band { position: fixed; left: 0; width: 100%; height: 40px; background-image: repeating-linear-gradient( -45deg, #ff3b3b, #ff3b3b 15px, transparent 15px, transparent 30px ); background-size: 42.4264px 42.4264px; box-shadow: 0 0 15px rgba(0, 0, 0, 0.5); animation: scroll-stripe 0.7s linear infinite; }
    .stripe-band.top { top: 0; }
    .stripe-band.bottom { bottom: 0; }
    @keyframes scroll-stripe { from { background-position-x: 0; } to { background-position-x: -42.4264px; } }
  </style>
</head>

<body>
  <div id="emergency-overlay">
    <div class="stripe-band top"></div>
    <div class="emergency-text-wrapper">
      <div class="emergency-title">Automatic Calling System</div>
      <div class="emergency-subtitle">æ³¨æ„å–šèµ·éŸ³</div>
    </div>
    <div class="stripe-band bottom"></div>
  </div>

  <div class="system-header">
    <div class="header-row">
      <div class="system-title" id="systemTitle">é€šä¿¡æŒ‡ä»¤ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿</div>
      <div class="system-status" id="status">STANDBY</div>
      
      <button id="toggleControls" class="btn">è¨­å®š</button>
      <button id="ttsToggle" class="btn">éŸ³å£°: OFF</button>
      <button id="syncBtn" class="btn primary">å†èª­ã¿è¾¼ã¿</button>

      
      <div class="system-clock" id="jst">--:--:--.-- JST</div>
    </div>
  </div>

  <div class="control-panel" id="controlPanel">
    <div class="control-row">
      <label class="setting-lavel">ãƒ‰ãƒ©ãƒãƒãƒƒã‚¯ãƒ¢ãƒ¼ãƒ‰ï¼ˆé‡å¤§äº‹æ¡ˆã®ã¿ç™ºç”Ÿã•ã›ã‚‹ãƒ¢ãƒ¼ãƒ‰ï¼‰</label>
      <button id="specialAlertModeToggle" class="btn">ãƒ‰ãƒ©ãƒãƒãƒƒã‚¯ãƒ¢ãƒ¼ãƒ‰: OFF</button>
      <label class="setting-lavel">æœ¬éƒ¨ã®åç§°</label>
      <input type="text" id="commanderInput" class="commander-input" value="æœ¬éƒ¨">
      <label class="setting-lavel">éŸ³å£°è¨­å®šï¼ˆéŸ³å£°ONã®æ™‚ã®ã¿ç·¨é›†å¯èƒ½ï¼‰</label>
      <button id="ttsToggle2" class="btn">éŸ³å£°: OFF</button>
      <select id="voiceSel">
        <option value="">éŸ³å£°è‡ªå‹•é¸æŠ</option>
      </select>
      <div class="rate-slider">
        <label>é€Ÿåº¦:</label>
        <input type="range" id="rateSlider" min="0.5" max="3.0" step="0.1" value="1.5">
        <span class="value" id="rateValue">1.5</span>
      </div>
      <div class="rate-slider">
        <label>å…¨ä½“éŸ³é‡:</label>
        <input type="range" id="masterVolumeSlider" min="0" max="2" step="0.05" value="1.0">
        <span class="value" id="masterVolumeValue">1.00</span>
      </div>
      <div class="rate-slider">
        <label>ãƒœã‚¤ã‚¹éŸ³é‡:</label>
        <input type="range" id="ttsVolumeSlider" min="0" max="1" step="0.05" value="1.0">
        <span class="value" id="ttsVolumeValue">1.00</span>
      </div>
      <div class="rate-slider">
        <label>åŠ¹æœéŸ³éŸ³é‡:</label>
        <input type="range" id="sfxVolumeSlider" min="0" max="1" step="0.05" value="1.0">
        <span class="value" id="sfxVolumeValue">1.00</span>
      </div>
      <div class="rate-slider">
        <label>æ™‚å ±éŸ³é‡:</label>
        <input type="range" id="timeSigVolumeSlider" min="0" max="1" step="0.05" value="0.5">
        <span class="value" id="timeSigVolumeValue">0.50</span>
      </div>
      <div class="rate-slider">
        <label>ç„¡ç·šãƒã‚¤ã‚ºéŸ³é‡:</label>
        <input type="range" id="noiseVolumeSlider" min="0" max="1" step="0.05" value="0.5">
        <span class="value" id="noiseVolumeValue">0.50</span>
      </div>
      
      <button id="closeControlsBtn" class="btn">é–‰ã˜ã‚‹</button>
    </div>
  </div>

  <div class="main-content">
    <div class="case-panel">
      <div class="panel-header">
        <div class="panel-title">é€²è¡Œä¸­ã®äº‹æ¡ˆ</div>
      </div>
      <div class="case-list" id="caseList">
        <div class="no-cases">CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã‚“ã§ãã ã•ã„</div>
      </div>
    </div>

    <div class="radio-panel">
      <div class="radio-log" id="log"></div>
    </div>
  </div>
<script>
// ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
let ttsVolume = 1.0; // TTSéŸ³é‡ã ã‘ã¯åˆ¥ã§ä¿æŒ
let isSpecialAlertMode = false; // â–¼â–¼â–¼ã€è¿½åŠ ã€‘ãƒ‰ãƒ©ãƒãƒãƒƒã‚¯ãƒ¢ãƒ¼ãƒ‰ãƒ¢ãƒ¼ãƒ‰ã®çŠ¶æ…‹ç®¡ç†ãƒ•ãƒ©ã‚°

const BASE_CPS = 12;
let commanderName = "æœ¬éƒ¨";
let whiteNoiseNode = null;
let TTS_ENABLED = false;
let chosenVoice = null;
let ttsRate = 1.5;
let audioCtx = null;
let masterGain = null;
let timeSigGain = null; // â˜… NEW: æ™‚å ±å°‚ç”¨
let sfxGain = null;
let noiseGain = null;
let scenarioLoader = null;
let scenarioEngine = null;
let runningToken = 0;
let tickTimer = null;
let userScrolling = false;
let scrollTimeout = null;

// ==========================================
// è¨­å®šã®ä¿å­˜ãƒ»å¾©å…ƒã€ãŠã‚ˆã³é–¢é€£å‡¦ç†
// ==========================================

const SETTINGS_KEY = 'simulatorSettings';

function saveSettings() {
  const settings = {
    commanderName: document.getElementById('commanderInput').value.trim() || "æœ¬éƒ¨",
    ttsRate:       parseFloat(document.getElementById('rateSlider').value),

    masterVolume:  parseFloat(document.getElementById('masterVolumeSlider').value),
    ttsVolume:     parseFloat(document.getElementById('ttsVolumeSlider').value),
    sfxVolume:     parseFloat(document.getElementById('sfxVolumeSlider').value),

    // â˜… è¿½åŠ : æ™‚å ±éŸ³é‡
    timeSigVolume: parseFloat(document.getElementById('timeSigVolumeSlider').value),

    noiseVolume:   parseFloat(document.getElementById('noiseVolumeSlider').value),

    voiceIndex:    parseInt(document.getElementById('voiceSel').value) || 0,
    ttsEnabled:    TTS_ENABLED,
    isSpecialAlertMode: isSpecialAlertMode
  };

  localStorage.setItem(SETTINGS_KEY, JSON.stringify(settings));
}

async function loadSettings() {
  const savedSettings = localStorage.getItem(SETTINGS_KEY);
  if (!savedSettings) {
    // åˆå›ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ
    const commanderInput = document.getElementById("commanderInput");
    document.getElementById("systemTitle").textContent =
      `${commanderInput.value.trim()}é€šä¿¡æŒ‡ä»¤ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿`;

    // éŸ³å£°OFFæ‰±ã„ãªã®ã§ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ç„¡åŠ¹åŒ–
    const sliders = document.querySelectorAll('.rate-slider, #voiceSel');
    sliders.forEach(el => el.classList.add('disabled'));
    return;
  }

  try {
    const settings = JSON.parse(savedSettings);

    // æœ¬éƒ¨å
    const commanderInput = document.getElementById('commanderInput');
    commanderName = settings.commanderName || "æœ¬éƒ¨";
    commanderInput.value = commanderName;
    document.getElementById("systemTitle").textContent =
      `${commanderName}é€šä¿¡æŒ‡ä»¤ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿`;

    // ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼å€¤ã‚’UIã«æˆ»ã™
    const sliders = {
      rateSlider:           { valueId: 'rateValue',           key: 'ttsRate',        fixed: 1, globalVar: 'ttsRate' },
      masterVolumeSlider:   { valueId: 'masterVolumeValue',   key: 'masterVolume',   fixed: 2 },
      ttsVolumeSlider:      { valueId: 'ttsVolumeValue',      key: 'ttsVolume',      fixed: 2, globalVar: 'ttsVolume' },
      sfxVolumeSlider:      { valueId: 'sfxVolumeValue',      key: 'sfxVolume',      fixed: 2 },
      timeSigVolumeSlider:  { valueId: 'timeSigVolumeValue',  key: 'timeSigVolume',  fixed: 2 },
      noiseVolumeSlider:    { valueId: 'noiseVolumeValue',    key: 'noiseVolume',    fixed: 2 },
    };

    for (const [sliderId, data] of Object.entries(sliders)) {
      if (settings[data.key] !== undefined) {
        const sliderEl = document.getElementById(sliderId);
        const value = parseFloat(settings[data.key]);

        sliderEl.value = value;
        document.getElementById(data.valueId).textContent =
          value.toFixed(data.fixed);

        if (data.globalVar === 'ttsRate') {
          ttsRate = value;
        } else if (data.globalVar === 'ttsVolume') {
          ttsVolume = value;
        }
      }
    }

    // GainNodeå´ã¸åæ˜ ï¼ˆAudioContextãŒæ—¢ã«ã‚ã‚‹å ´åˆã ã‘ï¼‰
    if (masterGain && settings.masterVolume !== undefined) {
      masterGain.gain.setValueAtTime(
        parseFloat(settings.masterVolume),
        audioCtx?.currentTime || 0
      );
    }
    if (timeSigGain && settings.timeSigVolume !== undefined) {
      timeSigGain.gain.setValueAtTime(
        parseFloat(settings.timeSigVolume),
        audioCtx?.currentTime || 0
      );
    }
    if (sfxGain && settings.sfxVolume !== undefined) {
      sfxGain.gain.setValueAtTime(
        parseFloat(settings.sfxVolume),
        audioCtx?.currentTime || 0
      );
    }
    if (noiseGain && settings.noiseVolume !== undefined) {
      noiseGain.gain.setValueAtTime(
        parseFloat(settings.noiseVolume),
        audioCtx?.currentTime || 0
      );
    }

    // ç‰¹åˆ¥è­¦æˆ’ãƒ¢ãƒ¼ãƒ‰çŠ¶æ…‹
    if (typeof settings.isSpecialAlertMode === 'boolean') {
      isSpecialAlertMode = settings.isSpecialAlertMode;
      const specialAlertModeBtn = document.getElementById("specialAlertModeToggle");
      specialAlertModeBtn.textContent =
        `ç‰¹åˆ¥è­¦æˆ’: ${isSpecialAlertMode ? "ON" : "OFF"}`;
      specialAlertModeBtn.classList.toggle("active", isSpecialAlertMode);
    }

    // ===============================
    // Safari / iOS / macOS å¯¾å¿œ:
    // éŸ³å£°ãƒªã‚¹ãƒˆã‚’å®‰å®šå–å¾—ã—ã¦ chosenVoice ã‚’æ±ºã‚ã‚‹
    // ===============================
    const voiceSelect = document.getElementById('voiceSel');
    if ('speechSynthesis' in window) {
      const voicesReady = new Promise(resolve => {
        let voices = speechSynthesis.getVoices();
        if (voices.length) {
          resolve(voices);
        } else {
          // Safariã¯åˆå›ã“ã“ã«å…¥ã‚‹: voiceschanged ã‚’1å›ã ã‘å¾…ã¤
          window.addEventListener(
            'voiceschanged',
            () => resolve(speechSynthesis.getVoices()),
            { once: true }
          );
        }
      });

      const voices = await voicesReady;

      // éŸ³å£°é¸æŠè‚¢ã‚’æ›´æ–°ï¼ˆæ—¥æœ¬èªå„ªå…ˆï¼‰
      voiceSelect.innerHTML = voices
        .filter(v => /^ja/i.test(v.lang))
        .map((v, i) => `<option value="${i}">${v.name} (${v.lang})</option>`)
        .join('');

      const voiceIndex = parseInt(settings.voiceIndex) || 0;
      voiceSelect.value = voiceIndex;

      chosenVoice =
        voices[voiceIndex] ||
        voices.find(v => /^ja/i.test(v.lang)) ||
        voices[0] ||
        null;
    }

  } catch (e) {
    console.error("è¨­å®šã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ:", e);
    localStorage.removeItem(SETTINGS_KEY);
  }
}


function toggleTTS() {
  const wasEnabled = TTS_ENABLED; // ç›´å‰ã®çŠ¶æ…‹ã‚’è¦šãˆã¦ãŠã
  TTS_ENABLED = !TTS_ENABLED;
  
  const btn1 = document.getElementById("ttsToggle");
  const btn2 = document.getElementById("ttsToggle2");
  const text = `éŸ³å£°: ${TTS_ENABLED ? "ON" : "OFF"}`;
  const className = TTS_ENABLED ? "btn active" : "btn";

  btn1.textContent = text;
  btn1.className = className;
  btn2.textContent = text;
  btn2.className = className;

  const sliders = document.querySelectorAll('.rate-slider, #voiceSel');
  sliders.forEach(el => el.classList.toggle('disabled', !TTS_ENABLED));

  if (TTS_ENABLED) {
    // ONã«ã—ãŸã¨ã
    ensureAudio();
    startTimeSignal();
  } else {
    // OFFã«ã—ãŸã¨ã
    stopTimeSignal();
    if ('speechSynthesis' in window) {
      speechSynthesis.cancel();
    }

    // â­ã“ã“ã‚’è¿½åŠ ï¼šãƒ›ãƒ¯ã‚¤ãƒˆãƒã‚¤ã‚ºã‚’æ­¢ã‚ã‚‹
    if (wasEnabled) {
      // asyncã ã‘ã©å¾…ãŸãªãã¦OKã€‚æ­¢ã‚ã«è¡Œãã ã‘
      stopWhiteNoise();
    }
  }

  saveSettings();
}


/**
 * éŸ³å£°ON/OFFãƒœã‚¿ãƒ³ï¼ˆ2ã¤ï¼‰ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
 */
document.getElementById("ttsToggle").addEventListener("click", toggleTTS);
document.getElementById("ttsToggle2").addEventListener("click", toggleTTS);

// ==========================================
// ã‚·ãƒŠãƒªã‚ªCSVãƒ­ãƒ¼ãƒ€ãƒ¼
// ==========================================

class ScenarioLoader {
  constructor() {
    this.paramLists = {};
    this.scenarios = [];
    this.scenarioMap = new Map();
  }

  // â–¼â–¼â–¼ã€ã“ã“ã‹ã‚‰ä¿®æ­£ã€‘ã€ŒNAMEã€è¡Œã‚’ã€Œç¢ºç‡ã€è¡Œã«å¤‰æ›´ â–¼â–¼â–¼
  parseCSV(csvText) {
    const lines = csvText.split('\n').filter(line => {
      const trimmed = line.trim();
      return trimmed && !trimmed.startsWith('#');
    });

    let currentLevel = null;
    let currentScenario = null;
    const nodeStack = [];

    for (let i = 0; i < lines.length; i++) {
      const line = lines[i];
      const cols = this.parseCSVLine(line); 
      const sectionOrProb = cols[0].trim();
      const depth = this.getIndentDepth(line); // â˜… ã‚¤ãƒ³ãƒ‡ãƒ³ãƒˆã‚’å…ˆã«å–å¾—

      if (sectionOrProb === 'PARAM') {
        // PARAM, id, , , , , params
        const [, id, , , , , params] = cols;
        this.paramLists[id] = params ? params.split(';').map(s => s.trim()) : [];
      } 
      else if (sectionOrProb === 'LEVEL') {
        // LEVEL, id, ...
        const [, id] = cols;
        currentLevel = { level: id, scenarios: [] };
        this.scenarios.push(currentLevel);
        nodeStack.length = 0; 
      }
      else if (depth === 0 && !isNaN(parseFloat(sectionOrProb))) {
        // äº‹æ¡ˆå®šç¾©è¡Œ (ã‚¤ãƒ³ãƒ‡ãƒ³ãƒˆ0 ã‹ã¤ 1åˆ—ç›®ãŒæ•°å€¤)
        // ä¾‹: 0.5,ãƒã‚¤ã‚¸ãƒ£ãƒƒã‚¯äº‹æ¡ˆ,,,,,type=hijack;level=4
        
        const probability = parseFloat(sectionOrProb);
        const id = cols[1]; // ãƒã‚¤ã‚¸ãƒ£ãƒƒã‚¯äº‹æ¡ˆ
        const params = cols[6]; // 7åˆ—ç›®
        const paramsObj = this.parseParams(params);

        // LEVELè¡ŒãŒCSVã«ãªã„å ´åˆã€paramsã®level=Nã‹ã‚‰æ¨æ¸¬ï¼ˆãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼‰
        if (!currentLevel) {
            const levelStr = `Lv${parseInt(paramsObj.level) || 1}`;
            currentLevel = this.scenarios.find(l => l.level === levelStr);
            if (!currentLevel) {
                currentLevel = { level: levelStr, scenarios: [] };
                this.scenarios.push(currentLevel);
            }
        }

        currentScenario = {
          name: id,
          type: paramsObj.type || 'unknown',
          level: parseInt(paramsObj.level) || 1,
          probability: probability, // â˜… 1åˆ—ç›®ã®ç¢ºç‡ã‚’äº‹æ¡ˆã®ç™ºç”Ÿç¢ºç‡ã¨ã—ã¦è¨­å®š
          rootNodes: []
        };
        currentLevel.scenarios.push(currentScenario);
        this.scenarioMap.set(paramsObj.type, currentScenario);
        nodeStack.length = 0; // ã‚¹ã‚¿ãƒƒã‚¯ãƒªã‚»ãƒƒãƒˆ
      }
      else if (currentScenario && depth > 0 && !isNaN(parseFloat(sectionOrProb))) {
        // NODEè¡Œ (ã‚¤ãƒ³ãƒ‡ãƒ³ãƒˆã‚ã‚Š ã‹ã¤ 1åˆ—ç›®ãŒæ•°å€¤)
        // ä¾‹:   1.0,æ´¾é£è¦è«‹,{msg},"{params}"
        
        const probability = parseFloat(sectionOrProb);
        const phase = cols[1];
        const message = cols[2];
        const paramsStr = cols[3]; // 4ã‚«ãƒ©ãƒ ç›®
        const paramsObj = this.parseParams(paramsStr);
        
        const node = {
          id: phase.trim(),
          depth,
          condition: null, // â˜… ã‚ã¨ã§æ¨æ¸¬
          probability: probability,
          phase: phase,
          message: message,
          params: paramsObj,
          children: []
        };

        // è¦ªãƒãƒ¼ãƒ‰ã‚’æ¢ã™ (è‡ªåˆ†ã‚ˆã‚Šæµ…ã„ã‚¤ãƒ³ãƒ‡ãƒ³ãƒˆãŒè¦‹ã¤ã‹ã‚‹ã¾ã§ã‚¹ã‚¿ãƒƒã‚¯ã‚’é¡ã‚‹)
        while (nodeStack.length > 0 && nodeStack[nodeStack.length - 1].depth >= depth) {
          nodeStack.pop();
        }

        if (nodeStack.length === 0) {
          // è¦ªãŒã„ãªã„ ï¼ rootNode
          // (depth === 1 ã§ã‚ã‚‹ã“ã¨ã‚’æœŸå¾…ã™ã‚‹ãŒã€depth > 0 ã§ã‚ã‚Œã°rootNodeã¨ã—ã¦æ‰±ã†)
          node.condition = 'default'; // â˜… 'new_case' ã¯ä½¿ã‚ã‚Œãªã„ã®ã§ 'default' ã«
          currentScenario.rootNodes.push(node);
        } else {
          // å­ãƒãƒ¼ãƒ‰
          const parentNode = nodeStack[nodeStack.length - 1];
          parentNode.children.push(node);
          
          // Conditionã®æ¨æ¸¬
          if (parentNode.params && parentNode.params['need-response'] === 'true') {
              node.condition = 'awaiting_response';
          } else {
              node.condition = 'default'; 
          }
        }
        nodeStack.push(node); // è‡ªåˆ†ã‚’ã‚¹ã‚¿ãƒƒã‚¯ã«è¿½åŠ 
      }
    }
  }
  // â–²â–²â–²ã€ã“ã“ã¾ã§ä¿®æ­£ã€‘â–²â–²â–²
  
  parseCSVLine(line) {
    const regex = /(?:^|,)(\"(?:[^\"]+|\"\")*\"|[^,]*)/g;
    const result = [];
    let match;
    while (match = regex.exec(line)) {
      let value = match[1];
      if (value.startsWith('"') && value.endsWith('"')) {
        value = value.substring(1, value.length - 1).replace(/""/g, '"');
      }
      result.push(value.trim());
    }
    
    if (line.endsWith(',')) {
        result.push('');
    }

    while (result.length < 7) {
      result.push('');
    }

    return result;
  }

  getIndentDepth(line) {
    const match = line.match(/^(\s*)/);
    if (!match) return 0;

    // 1. ã‚¿ãƒ–æ–‡å­—(\t)ã‚’ã€æ„å›³ã™ã‚‹ã€ŒåŠè§’ã‚¹ãƒšãƒ¼ã‚¹2ã¤ã€ã«ç½®æ›
    let indentString = match[1].replace(/\t/g, '  ');
    
    // 2. ãã®ä»–ã®ç‰¹æ®Šãªç©ºç™½æ–‡å­—(\u00A0ãªã©)ã‚’åŠè§’ã‚¹ãƒšãƒ¼ã‚¹ã«æ­£è¦åŒ–
    indentString = indentString.replace(/\u00A0/g, ' '); 
    
    // â–¼â–¼â–¼ã€æœ€çµ‚ä¿®æ­£ã€‘å…¨è§’ã‚¹ãƒšãƒ¼ã‚¹ã‚’åŠè§’ã‚¹ãƒšãƒ¼ã‚¹2ã¤ã«ç½®æ› â–¼â–¼â–¼
    indentString = indentString.replace(/ã€€/g, '  ');
    // â–²â–²â–²ã€æœ€çµ‚ä¿®æ­£ã€‘â–²â–²â–²

    // æ­£è¦åŒ–ã•ã‚ŒãŸæ–‡å­—åˆ—ã®é•·ã•ã§ã€ã‚¤ãƒ³ãƒ‡ãƒ³ãƒˆãƒ¬ãƒ™ãƒ«ã‚’è¨ˆç®—
    // (ã‚¹ãƒšãƒ¼ã‚¹2ã¤ã§ã‚¤ãƒ³ãƒ‡ãƒ³ãƒˆ1ã¨ã™ã‚‹)
    return Math.floor(indentString.length / 2);
  }

  parseParams(paramsStr) {
    if (!paramsStr) return {};
    const pairs = paramsStr.split(';').filter(p => p.trim());
    const result = {};
    for (const pair of pairs) {
      const [key, value] = pair.split('=').map(s => s.trim());
      // â–¼â–¼â–¼ã€ä¿®æ­£ã€‘ã‚­ãƒ¼é‡è¤‡æ™‚ã«ä¸Šæ›¸ãã›ãšã€';'ã§é€£çµã™ã‚‹ â–¼â–¼â–¼
      if (key && value) {
        if (result[key]) {
          result[key] = `${result[key]};${value}`;
        } else {
          result[key] = value;
        }
      }
      // â–²â–²â–²ã€ä¿®æ­£ã€‘â–²â–²â–²
    }
    return result;
  }
  
  async loadFromFile(file) {
    return new Promise((resolve, reject) => {
      const reader = new FileReader();
      reader.onload = (e) => {
        try {
          this.parseCSV(e.target.result);
          resolve();
        } catch (error) {
          reject(error);
        }
      };
      reader.onerror = reject;
      reader.readAsText(file);
    });
  }
}

// ==========================================
// ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãƒ‘ãƒ¼ã‚µãƒ¼
// ==========================================
class MessageParser {
  constructor(paramLists) {
    this.paramLists = paramLists;
  }

  parse(template, context) {
    let result = template;
    let lastResult = '';

    while (result !== lastResult) {
        lastResult = result;

        result = result.replace(/\{([^}#]+\/[^}]+)\}/g, (match, items) => {
          const choices = items.split('/').map(s => s.trim());
          const index = Math.floor(Math.random() * choices.length);
          return choices[index];
        });

        result = result.replace(/\{#(\w+):(\d+)-(\d+)\}/g, (match, name, min, max) => {
          const minVal = parseInt(min);
          const maxVal = parseInt(max);
          return Math.floor(Math.random() * (maxVal - minVal + 1)) + minVal;
        });

        result = result.replace(/\{#(\w+)\}/g, (match, name) => {
          if (name === 'num') {
            return Math.floor(Math.random() * 3) + 1;
          }
          if (name === 'eta') {
            return Math.floor(Math.random() * 9) + 2;
          }
          if (this.paramLists[name]) {
            const list = this.paramLists[name];
            const index = Math.floor(Math.random() * list.length);
            return list[index];
          }
          return match;
        });

        result = result.replace(/\{(\w+)\}/g, (match, key) => {
          const value = context[key];
          return (value !== undefined && value !== null) ? value : '';
        });
    }

    result = result.replace(/\{([^{}]+)\}/g, (match, content) => content);
    result = result.replace(/ã€\s*ã€/g, 'ã€').replace(/ã€$/g, '');

    return result;
  }
}


// ==========================================
// ã‚·ãƒŠãƒªã‚ªã‚¨ãƒ³ã‚¸ãƒ³
// ==========================================
class ScenarioEngine {
  constructor(loader, unitTypes) {
    this.loader = loader;
    this.parser = new MessageParser(loader.paramLists);
    this.unitTypes = unitTypes;
    this.activeCases = new Map();
    this.caseIdCounter = 1;
    this.nodeIdCounter = 1;
    // backup-allæ©Ÿèƒ½ç”¨ã®ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£
    this.isBackupAllActive = false;
    this.backupAllCaseId = null;
  }

  evaluateCondition(condition, caseState) {
    if (!condition) return false;
    switch (condition) {
      case 'new_case': return caseState.isNew;
      case 'awaiting_response': return caseState.awaitingResponse;
      case 'default': return true;
      case 'has_units': return caseState.hasAvailableBackupUnits;
      default:
        if (condition.startsWith('rand<')) {
          const threshold = parseFloat(condition.substring(5));
          return Math.random() < threshold;
        }
        return false;
    }
  }

  selectNextNode(currentNode, caseState) {
    const candidates = currentNode.children.filter(child => {
      const conditionMet = this.evaluateCondition(child.condition, caseState);
      const probabilityMet = Math.random() < child.probability;
      return conditionMet && probabilityMet;
    });
    if (candidates.length === 0) {
      return currentNode.children.find(child => child.condition === 'default') || null;
    }
    return candidates[0];
  }


// â–¼â–¼â–¼ã€ã“ã“ã‹ã‚‰ä¿®æ­£ã€‘rootNodeãŒè¤‡æ•°ã‚ã‚‹å ´åˆã®ç¢ºç‡åˆ†å²ã«å¯¾å¿œ â–¼â–¼â–¼
generateNewCase(busyUnits) {

  const randomDelay = Math.random() * 4000 + 500;
  // â–¼â–¼â–¼ã€ã“ã“ã‹ã‚‰å¤‰æ›´ã€‘ãƒ‰ãƒ©ãƒãƒãƒƒã‚¯ãƒ¢ãƒ¼ãƒ‰ãƒ¢ãƒ¼ãƒ‰ã®ãƒ­ã‚¸ãƒƒã‚¯ â–¼â–¼â–¼
  let candidateScenarios;
  if (isSpecialAlertMode) {
  // å…¨ã‚·ãƒŠãƒªã‚ªã‚’ä¸€æ—¦ãƒ•ãƒ©ãƒƒãƒˆã«ã—ã¦ã‹ã‚‰ã€
  // ãã®ã‚·ãƒŠãƒªã‚ªå€‹åˆ¥ã® .level ãŒ 3ä»¥ä¸Šã®ã‚‚ã®ã ã‘æ®‹ã™
  candidateScenarios = this.loader.scenarios
    .flatMap(levelGroup => levelGroup.scenarios)
    .filter(scenario => scenario.level >= 3);
} else {
  // é€šå¸¸æ™‚ã¯å…¨éƒ¨
  candidateScenarios = this.loader.scenarios
    .flatMap(levelGroup => levelGroup.scenarios);
}
// é€šå¸¸ãƒ¢ãƒ¼ãƒ‰ã®å ´åˆã¯ã™ã¹ã¦ã®ã‚·ãƒŠãƒªã‚ªã‚’å€™è£œã«ã™ã‚‹

  
  const totalWeight = candidateScenarios.reduce((sum, s) => sum + s.probability, 0);
  if (totalWeight <= 0) return null;

  // ã‚·ãƒŠãƒªã‚ªã‚’ç¢ºç‡ã«åŸºã¥ã„ã¦é¸æŠ
  let selectedScenario = null;
  const r = Math.random() * totalWeight;
  let cumulative = 0;
  for (const scenario of candidateScenarios) { // å€™è£œãƒªã‚¹ãƒˆã‚’ `candidateScenarios` ã«å¤‰æ›´
      cumulative += scenario.probability;
      if (r <= cumulative) {
          selectedScenario = scenario;
          break;
      }
  }
  // â–²â–²â–²ã€ã“ã“ã¾ã§å¤‰æ›´ã€‘â–²â–²â–²
  
  if (!selectedScenario) return null;

  // â–¼â–¼â–¼ã€ã“ã“ã‹ã‚‰å¤‰æ›´ã€‘rootNodesã‹ã‚‰ç¢ºç‡ã§é¸æŠ â–¼â–¼â–¼
  if (!selectedScenario.rootNodes || selectedScenario.rootNodes.length === 0) {
      console.error(`ã‚·ãƒŠãƒªã‚ª "${selectedScenario.name}" ã«ãƒ«ãƒ¼ãƒˆãƒãƒ¼ãƒ‰ãŒã‚ã‚Šã¾ã›ã‚“ã€‚`);
      return null;
  }

  let firstNode = null;
  if (selectedScenario.rootNodes.length === 1) {
      firstNode = selectedScenario.rootNodes[0];
  } else {
      // è¤‡æ•°ã®rootNodeãŒã‚ã‚‹å ´åˆã€ç¢ºç‡ã§åˆ†å²
      const totalRootWeight = selectedScenario.rootNodes.reduce((sum, node) => sum + node.probability, 0);
      const rNode = Math.random() * totalRootWeight;
      let cumulativeNode = 0;
      for (const node of selectedScenario.rootNodes) {
          cumulativeNode += node.probability;
          if (rNode <= cumulativeNode) {
              firstNode = node;
              break;
          }
      }
      if (!firstNode) firstNode = selectedScenario.rootNodes[0]; // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
  }
  // â–²â–²â–²ã€å¤‰æ›´ã“ã“ã¾ã§ã€‘â–²â–²â–²

  const isTriggeringBackupAll = firstNode.params && firstNode.params['backup-all'] === 'true';

  // â–¼â–¼â–¼ã€ã“ã“ã‹ã‚‰ä¿®æ­£ã€‘backup-allãŒæ—¢ã«ç™ºä»¤ä¸­ã®å ´åˆã€æ–°ã—ã„backup-alläº‹æ¡ˆã‚’ç”Ÿæˆã—ãªã„ â–¼â–¼â–¼
  if (this.isBackupAllActive && isTriggeringBackupAll) {
      console.log(`[System] generateNewCase: æ—¢å­˜ã®backup-alläº‹æ¡ˆ (${this.backupAllCaseId}) ãŒå®Ÿè¡Œä¸­ã®ãŸã‚ã€æ–°è¦backup-alläº‹æ¡ˆ (${selectedScenario.name}) ã®ç”Ÿæˆã‚’å¾…æ©Ÿã—ã¾ã™ã€‚`);
      return null; // â˜…â˜…â˜… æ–°è¦ã®backup-alläº‹æ¡ˆã‚’ãƒ–ãƒ­ãƒƒã‚¯
  }
  // â–²â–²â–²ã€ä¿®æ­£ã“ã“ã¾ã§ã€‘â–²â–²â–²

  const availableBackupUnits = (this.unitTypes.backup || []).filter(u => !busyUnits.has(u));
  
  let unit;
  let backupUnitsForCase = [];

  // --- backup-allã¨é€šå¸¸äº‹æ¡ˆã®åˆ†å²å‡¦ç† ---
  if (isTriggeringBackupAll) {
      // --- backup-allã®ãƒ­ã‚¸ãƒƒã‚¯ ---
      // (ã“ã®æ™‚ç‚¹ã§ this.isBackupAllActive ã¯ false ã§ã‚ã‚‹ã“ã¨ãŒä¿è¨¼ã•ã‚Œã¦ã„ã‚‹)
      console.log('--- DEBUG: generateNewCase (backup-all) ---');
      console.log('this.unitTypes.backup:', this.unitTypes.backup);
      console.log('availableBackupUnits.length:', availableBackupUnits.length);
      console.log('---------------------------------');

      if (availableBackupUnits.length === 0) {
          // â˜… ãƒ¦ãƒ‹ãƒƒãƒˆä¸è¶³ã§ç™ºä»¤ã§ããªã„å ´åˆã‚‚å¾…æ©Ÿ
          console.log(`[System] generateNewCase: backup-alläº‹æ¡ˆ (${selectedScenario.name}) ã‚’ç”Ÿæˆã—ã‚ˆã†ã¨ã—ã¾ã—ãŸãŒã€åˆ©ç”¨å¯èƒ½ãªãƒ¦ãƒ‹ãƒƒãƒˆãŒ0ã®ãŸã‚å¾…æ©Ÿã—ã¾ã™ã€‚`);
          return null;
      }
      
      const primaryUnitIndex = Math.floor(Math.random() * availableBackupUnits.length);
      unit = availableBackupUnits[primaryUnitIndex];
      backupUnitsForCase = availableBackupUnits.filter((_, index) => index !== primaryUnitIndex);

      // ã‚°ãƒ­ãƒ¼ãƒãƒ«ãªbackup-allçŠ¶æ…‹ã‚’è¨­å®š
      this.isBackupAllActive = true;
      this.backupAllCaseId = `C${String(this.caseIdCounter).padStart(4, '0')}`; // â˜… IDã¯å¾Œã§è¨­å®šã™ã‚‹caseIdã¨åˆã‚ã›ã‚‹

  } else {
      // --- é€šå¸¸äº‹æ¡ˆã®ãƒ­ã‚¸ãƒƒã‚¯ ---
      
      // â–¼â–¼â–¼ã€è¿½åŠ ã€‘backup-allç™ºä»¤ä¸­ã¯ã€backupãƒ¦ãƒ‹ãƒƒãƒˆã‚’å¿…è¦ã¨ã™ã‚‹æ–°è¦äº‹æ¡ˆã‚’ãƒ–ãƒ­ãƒƒã‚¯ â–¼â–¼â–¼
      const scenarioType = selectedScenario.type;
      if (this.isBackupAllActive && scenarioType === 'backup') {
          console.log(`[System] generateNewCase: backup-allç™ºä»¤ä¸­ã®ãŸã‚ã€æ–°è¦backupäº‹æ¡ˆ (${selectedScenario.name}) ã®ç”Ÿæˆã‚’å¾…æ©Ÿã—ã¾ã™ã€‚`);
          return null;
      }
      // â–²â–²â–²ã€è¿½åŠ ã“ã“ã¾ã§ã€‘â–²â–²â–²
      
      let unitTypeKey;
      
      if (['investigation'].includes(scenarioType)) {
          unitTypeKey = 'investigation';
      } else if (['traffic'].includes(scenarioType)) {
          unitTypeKey = 'traffic';
      } else if (['patrol'].includes(scenarioType)) {
          unitTypeKey = 'patrol';
      } else {
          unitTypeKey = 'backup';
      }
      
      const unitPool = this.unitTypes[unitTypeKey] || [];
      const availableUnitsForCase = unitPool.filter(u => !busyUnits.has(u));
      
      if (unitTypeKey === 'backup') {
          const backupUnitsBusy = Array.from(busyUnits).some(u => 
              (this.unitTypes.backup || []).includes(u)
          );
          
          if (backupUnitsBusy) {
              return null;
          }
      }
      
      if (availableUnitsForCase.length === 0) {
          return null;
      }
      unit = availableUnitsForCase[Math.floor(Math.random() * availableUnitsForCase.length)];
  }

  // --- å…¨ã¦ã®äº‹æ¡ˆã«å…±é€šã®ãƒ­ã‚¸ãƒƒã‚¯ ---
  const caseId = `C${String(this.caseIdCounter++).padStart(4, '0')}`;
  if (isTriggeringBackupAll) {
      this.backupAllCaseId = caseId; // â˜…ã“ã“ã§caseIdã‚’æ­£å¼ã«å‰²ã‚Šå½“ã¦
  }
  const zoneList = this.loader.paramLists.zones || [];
  const zone = zoneList[Math.floor(Math.random() * zoneList.length)];
  
  const caseObj = {
    id: caseId, scenario: selectedScenario, currentNode: firstNode,
    zone, unit, backupUnits: backupUnitsForCase, level: selectedScenario.level,
    startTime: Date.now(), awaitingResponse: true, phase: firstNode.phase,
    isVisible: false
  };

  if (firstNode.params && firstNode.params.add_units) {
      const newUnits = new Set(caseObj.backupUnits);
      // â–¼â–¼â–¼ã€ä¿®æ­£ã€‘';' ã¨ 'ãƒ»' ã®ä¸¡æ–¹ã§åˆ†å‰²ã—ã¦ãƒ¦ãƒ‹ãƒƒãƒˆã‚’è¿½åŠ  â–¼â–¼â–¼
      firstNode.params.add_units.split(';').forEach(unitGroup => {
        unitGroup.split('ãƒ»').forEach(unitName => {
          const trimmedName = unitName.trim();
          if (trimmedName) newUnits.add(trimmedName);
        });
      });
      // â–²â–²â–²ã€ä¿®æ­£ã€‘â–²â–²â–²
      caseObj.backupUnits = Array.from(newUnits);
  }
  
  caseObj.backupUnits = caseObj.backupUnits.filter(bu => bu !== caseObj.unit);

  if (firstNode.params && firstNode.params.escalate_level) {
      const newLevel = parseInt(firstNode.params.escalate_level, 10);
      if (!isNaN(newLevel)) {
          caseObj.level = newLevel;
      }
  }

  this.activeCases.set(caseId, caseObj);
  const context = { unit, zone, type_ja: selectedScenario.name, commander: commanderName };
  let message = this.parser.parse(firstNode.message, context);
  
  return {
    id: `N${String(this.nodeIdCounter++).padStart(6, '0')}`,
    caseId, 
    level: caseObj.level,
    phase: firstNode.phase, zone, unit, message, scenarioName: selectedScenario.name,
    params: firstNode.params
  };
}

progressCase(caseId, busyUnits) {
  console.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');
  console.log('ğŸ”µ progressCase: é–‹å§‹');
  console.log('  äº‹æ¡ˆID:', caseId);
  console.log('  isBackupAllActive:', this.isBackupAllActive);
  console.log('  backupAllCaseId:', this.backupAllCaseId);

  // å®‰å…¨ç”¨ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£åˆæœŸåŒ–
  if (this.lastBackupAllActivity === undefined) {
    this.lastBackupAllActivity = Date.now();
  }
  if (this.backupAllStallWarned === undefined) {
    this.backupAllStallWarned = false;
  }

  // å¯¾è±¡äº‹æ¡ˆ
  const caseObj = this.activeCases.get(caseId);
  if (!caseObj) {
    console.log('  âŒ äº‹æ¡ˆãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
    return null;
  }

  console.log('  ğŸ“‹ ç¾åœ¨ã®ãƒ•ã‚§ãƒ¼ã‚º:', caseObj.phase);
  console.log('  ğŸ“‹ ç¾åœ¨ã®ãƒ¦ãƒ‹ãƒƒãƒˆ:', caseObj.unit);
  console.log('  ğŸ“‹ ç¾åœ¨ã®ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—:', [...caseObj.backupUnits]);

  // ã„ã¾ç©ºã„ã¦ã‚‹å¿œæ´éƒ¨éšŠ
  const allBackupUnits = this.unitTypes.backup || [];
  console.log('  ğŸ“Š å…¨backup_unit:', allBackupUnits);
  console.log('  ğŸ“Š busyUnits:', Array.from(busyUnits));

  const availableBackupUnits = allBackupUnits.filter(u => !busyUnits.has(u));
  console.log('  âœ… åˆ©ç”¨å¯èƒ½ãªbackup_unit:', availableBackupUnits);
  console.log('  ğŸ“ˆ åˆ©ç”¨å¯èƒ½æ•°:', availableBackupUnits.length);

  // selectNextNodeç”¨ã®çŠ¶æ…‹
  const caseState = {
    id: caseId,
    isNew: false,
    awaitingResponse: caseObj.awaitingResponse,
    elapsed: Math.floor((Date.now() - caseObj.startTime) / 1000),
    hasAvailableBackupUnits: availableBackupUnits.length > 0
  };

  // æ¬¡ã«é€²ã‚€ã¹ããƒãƒ¼ãƒ‰
  const nextNode = this.selectNextNode(caseObj.currentNode, caseState);
  if (!nextNode) {
    console.log(`  â­ï¸ æ¬¡ã®ãƒãƒ¼ãƒ‰ãŒã‚ã‚Šã¾ã›ã‚“ (${caseId}) çµ‚äº†`);

    // ã“ã®äº‹æ¡ˆãŒ backup-all ã®æœ¬ä½“ã ã£ãŸå ´åˆã¯è‡ªç„¶çµ‚äº†ã§è§£é™¤
    if (this.isBackupAllActive && this.backupAllCaseId === caseId) {
      console.log(`[System] backup-alläº‹æ¡ˆ (${caseId}) ãŒçµ‚äº†ã€‚ãƒ¢ãƒ¼ãƒ‰ã‚’è§£é™¤ã—ã¾ã™ã€‚`);
      this.isBackupAllActive = false;
      this.backupAllCaseId = null;
    }

    this.activeCases.delete(caseId);

    if (caseObj.awaitingResponse) {
      caseObj.awaitingResponse = false;
    }
    return null;
  }

  console.log('  âœ… æ¬¡ã®ãƒãƒ¼ãƒ‰:', nextNode.phase);
  console.log('  ğŸ“‹ nextNode.condition:', nextNode.condition);
  console.log('  ğŸ“‹ nextNode.message:', (nextNode.message || '').substring(0, 80) + '...');
  console.log('  ğŸ“‹ nextNode.params:', nextNode.params);

  // ãƒ‡ãƒãƒƒã‚°ç”¨ã« peekï¼ˆ1æ‰‹å…ˆï¼‰ã ã‘ã¯ãƒ­ã‚°ã«å‡ºã—ã¦ãŠãï¼ˆãƒ–ãƒ­ãƒƒã‚¯åˆ¤å®šã§ã¯ä½¿ã‚ãªã„ï¼‰
  let peekNode = null;
  try {
    peekNode = this.selectNextNode(nextNode, caseState) || null;
  } catch (e) {
    console.warn('  âš ï¸ peekNodeå–å¾—æ™‚ã«ä¾‹å¤–:', e);
    peekNode = null;
  }
  if (peekNode) {
    console.log('  ğŸ” peekNode.phase:', peekNode.phase);
    console.log('  ğŸ” peekNode.message:', (peekNode.message || '').substring(0, 80) + '...');
    console.log('  ğŸ” peekNode.params:', peekNode.params);
  } else {
    console.log('  ğŸ” peekNode: (ãªã—)');
  }

  // ======================================================
  // å¾…æ©Ÿåˆ¤å®šãƒ­ã‚¸ãƒƒã‚¯
  // ======================================================

  // ã“ã®æ¡ˆä»¶ã«ã¯ã™ã§ã«å¿œæ´éƒ¨éšŠãŒå¼µã‚Šä»˜ã„ã¦ã„ã‚‹ï¼Ÿ
  const caseAlreadyHasBackup = (caseObj.backupUnits && caseObj.backupUnits.length > 0);

  // ã‚°ãƒ­ãƒ¼ãƒãƒ«ã§ã€Œä»Šã™ãå‹•ã‘ã‚‹å¿œæ´ã€ãŒã„ã‚‹ï¼Ÿ
  const backupAvailableNow = (availableBackupUnits.length > 0);

  // â‘ ã€Œç¾å ´ã‹ã‚‰ã®åˆå›å¿œæ´ãƒªã‚¯ã‚¨ã‚¹ãƒˆã€åˆ¤å®š
  //
  // ã¾ã ã“ã®æ¡ˆä»¶ã«å¿œæ´ãŒã„ãªã„çŠ¶æ…‹ã§ã€
  // nextNode ãŒã€Œå¿œæ´ãã ã•ã„ï¼è‡³æ€¥æ”¯æ´é¡˜ã„ãŸã„ã€ç³»ï¼ˆ= å¿œæ´è¦è«‹ãƒ•ã‚§ãƒ¼ã‚ºï¼‰ã‹ï¼Ÿ
  //
  // ã“ã‚Œã¯ dispatcherï¼ˆæœ¬éƒ¨ï¼‰ã§ã¯ãªãç¾å ´å´ãŒã€Œå¿œæ´ã‚’è¦è«‹ã™ã‚‹ã€ã¨è¨€ã£ã¦ã„ã‚‹æ®µéšã€‚
  // ã“ã®æ®µéšã§ã‚‚ã€ã‚‚ã†å¿œæ´ãŒå…¨å‡ºæ‰•ãªã‚‰ç„¡ç·šã‚’æµã•ãšè¶³è¸ã¿ã—ãŸã„ã€‚
  //
  const nodeIsFirstFieldRequest = (node) => {
    if (!node) return false;
    if (caseAlreadyHasBackup) return false; // ã‚‚ã†å¿œæ´ãŒä»˜ã„ã¦ã‚‹ãªã‚‰åˆå›è¦è«‹ã§ã¯ãªã„

    // åˆ¤å®šã®è»¸ã¯ãƒ•ã‚§ãƒ¼ã‚ºå or ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸æ–‡é¢
    const phaseSuggestsRequest =
      node.phase && node.phase.includes('å¿œæ´è¦è«‹');

    const text = node.message || '';
    const messageSuggestsRequest =
      text.includes('å¿œæ´ã‚’è¦è«‹') ||
      text.includes('å¿œæ´è¦è«‹') ||
      text.includes('è‡³æ€¥æ”¯æ´é¡˜ã„ãŸã„') ||
      text.includes('æ”¯æ´é¡˜ã„ãŸã„') ||
      text.includes('æ”¯æ´è¦è«‹');

    return phaseSuggestsRequest || messageSuggestsRequest;
  };

  // â‘¡ã€Œæœ¬éƒ¨ãŒæœ€åˆã®æ´¾é£æŒ‡ç¤ºã‚’å‡ºã™ã€åˆ¤å®š
  //
  // ã¾ã ã“ã®æ¡ˆä»¶ã«å¿œæ´ãŒã„ãªã„çŠ¶æ…‹ã§ã€
  // nextNode ãŒå®Ÿéš›ã« {backup_unit} ã‚’å‘¼ã¶ or backup-all=true ã‚’æ’ƒã¨ã†ã¨ã—ã¦ã„ã‚‹ãªã‚‰ã€
  // ãã‚Œã¯åˆå›æ´¾é£ï¼ˆæœ¬éƒ¨ã‚¢ãƒŠã‚¦ãƒ³ã‚¹ï¼‰ãªã®ã§æ­¢ã‚ãŸã„ã€‚
  //
  const nodeIsFirstDispatchFromHQ = (node) => {
    if (!node) return false;
    if (caseAlreadyHasBackup) return false; // æ—¢ã«å¿œæ´ãŒåˆ°ç€æ¸ˆã¿ãªã‚‰ã€Œ2å›ç›®ä»¥é™ã®å‘¼ã³ã‹ã‘ã€ãªã®ã§æ­¢ã‚ãªã„

    const mentionsBackupUnitInMessage =
      node.message && node.message.includes('{backup_unit}');
    const isBackupAllCall =
      node.params && node.params['backup-all'] === 'true';

    return (mentionsBackupUnitInMessage || isBackupAllCall);
  };

  const blockFieldRequest   = nodeIsFirstFieldRequest(nextNode);
  const blockHQDispatch     = nodeIsFirstDispatchFromHQ(nextNode);

  // ã©ã£ã¡ã‹ã«è©²å½“ã—ã€ã‹ã¤ä»Šã¯ç©ºã„ã¦ã‚‹å¿œæ´ãŒã„ãªã„ãªã‚‰å¾…æ©Ÿ
  //
  // - blockFieldRequest: ã€Œå¿œæ´ã‚’è¦è«‹ã™ã‚‹ã€‚è‡³æ€¥æ”¯æ´é¡˜ã„ãŸã„ã€‚ã€â†ã“ã“ã§æ­¢ã‚ãŸã„
  // - blockHQDispatch:   ã€Œ{backup_unit}ã€è‡³æ€¥ç¾å ´ã¸è»¢é€²ã›ã‚ˆã€‚ã€ã‚„ã€Œå…¨å¿œæ´ã‚’ã€â†ã“ã“ã§ã‚‚æ­¢ã‚ãŸã„
  //
  const shouldStandbyBecauseNoBackup =
    (blockFieldRequest || blockHQDispatch) && !backupAvailableNow;

  if (shouldStandbyBecauseNoBackup) {
    console.log('  â¸ å¿œæ´é–¢é€£ãƒ•ã‚§ãƒ¼ã‚ºã ãŒç©ºããªã—ã€‚å¾…æ©Ÿã—ã¾ã™ã€‚');
    console.log('     (blockFieldRequest=', blockFieldRequest,
                ', blockHQDispatch=', blockHQDispatch, ')');
    return null;
  }

  // ------------------------------------------------------
  // backup-allï¼ˆå…¨å¿œæ´æ‹›é›†ï¼‰ä¸­ã®ä»–æ¡ˆä»¶ã®è¶³æ­¢ã‚
  // ------------------------------------------------------
  //
  // åˆ¥ã®æ¡ˆä»¶ãŒ backup-all ã‚’èµ°ã‚‰ã›ã¦ã„ã‚‹å ´åˆã€
  // ä»–ã®æ¡ˆä»¶ãŒã€Œæ–°ã—ãå¿œæ´ã‚’å–ã‚ŠãŸã„ / backup-allã‚’æ–°è¦ã«å®£è¨€ã—ãŸã„ã€
  // ã¨ã„ã†å±€é¢ã«å…¥ã‚ã†ã¨ã—ãŸã‚‰å¾…æ©Ÿã•ã›ã‚‹ã€‚
  //
  // ãŸã ã—ã€æ—¢ã«å¿œæ´ãŒå¼µã‚Šä»˜ã„ã¦ã‚‹æ¡ˆä»¶ã§ã®å¾Œç¶šäº¤ä¿¡
  // ï¼ˆ=2å›ç›®ä»¥é™ã® {backup_unit} å‘¼ã³ã‹ã‘ï¼‰ã¯æ­¢ã‚ãªã„ã€‚
  //
  const thisNodeIsTryingToGetFreshBackupNow =
    (!caseAlreadyHasBackup) &&
    nextNode.message &&
    nextNode.message.includes('{backup_unit}');

  const thisNodeIsTryingToDeclareBackupAllNow =
    nextNode.params && nextNode.params['backup-all'] === 'true';

  const isRequestingNewBackupOrBackupAll =
    thisNodeIsTryingToGetFreshBackupNow || thisNodeIsTryingToDeclareBackupAllNow;

  if (this.isBackupAllActive &&
      this.backupAllCaseId !== caseId &&
      isRequestingNewBackupOrBackupAll) {

    console.log('  â¸ backup-allç™ºä»¤ä¸­ã€‚ä»–æ¡ˆä»¶ã¯å¾…æ©Ÿã—ã¾ã™ã€‚');
    console.log('     å„ªå…ˆç¾å ´:', this.backupAllCaseId, ' / ã“ã®äº‹æ¡ˆ:', caseId);
    console.log('     (isRequestingNewBackupOrBackupAll=', isRequestingNewBackupOrBackupAll, ')');

    // backup-allæœ¬ä½“ãŒé•·æ™‚é–“å‹•ã„ã¦ãªã„ã®ã«ãƒ­ãƒƒã‚¯ã—ç¶šã‘ã¦ã‚‹ã‚ˆã†ãªã‚‰è­¦å‘Šã ã‘å‡ºã™
    const now = Date.now();
    const stalledMs = now - (this.lastBackupAllActivity || 0);

    if (stalledMs > 90_000 && !this.backupAllStallWarned) {
      console.warn(
        `[Safety] backup-all(${this.backupAllCaseId}) ãŒ ${Math.floor(stalledMs / 1000)}ç§’é€²è¡Œãªã—ã®ã¾ã¾ãƒ­ãƒƒã‚¯ç¶™ç¶šä¸­ã€‚` +
        `çŠ¶æ³ç¢ºèªãŒå¿…è¦ãªå¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚`
      );
      this.backupAllStallWarned = true;
    }

    return null;
  }

  // ======================================================
  // ã“ã“ã‹ã‚‰å…ˆã¯ã€é€²è¡Œç¢ºå®šå‡¦ç†
  // ======================================================

  // backup-all ã®å®Ÿå‡¦ç†ï¼ˆå…¨éšŠæ‹›é›†ã‚’ã“ã®äº‹æ¡ˆãŒå®£è¨€ã™ã‚‹å ´åˆï¼‰
  const isBackupAllCallNow =
    nextNode.params && nextNode.params['backup-all'] === 'true';

  console.log('  ğŸš¨ isBackupAllCallNow:', isBackupAllCallNow);
  if (isBackupAllCallNow) {
    
    // â–¼â–¼â–¼ã€ãƒã‚°ä¿®æ­£ã€‘æ—¢å­˜ã®Backup-AllãŒã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãªå ´åˆã®ä¸Šæ›¸ãé˜²æ­¢ â–¼â–¼â–¼
    if (this.isBackupAllActive && this.backupAllCaseId !== caseId) {
        console.log(`  â¸ æ—¢å­˜ã®backup-all (${this.backupAllCaseId}) ãŒç™ºä»¤ä¸­ã®ãŸã‚ã€æ–°è¦ã®backup-all (${caseId}) å®£è¨€ã‚’å¾…æ©Ÿã—ã¾ã™ã€‚`);
        return null; // â˜… å¾…æ©Ÿ
    }
    // â–²â–²â–²ã€ãƒã‚°ä¿®æ­£ã€‘ã“ã“ã¾ã§ â–²â–²â–²

    console.log('  â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');
    console.log('  ğŸ”´ backup-allç™ºä»¤ï¼');
    console.log('  â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');

    this.isBackupAllActive = true;
    this.backupAllCaseId = caseId;

    console.log('  ğŸ”´ isBackupAllActive = true');
    console.log('  ğŸ”´ backupAllCaseId =', caseId);

    const beforeBackups = [...caseObj.backupUnits];
    console.log('  ğŸ“Š ç™ºä»¤å‰ã®ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—:', beforeBackups);

    // ã¾ã å…¥ã£ã¦ã„ãªã„å¿œæ´ãƒ¦ãƒ‹ãƒƒãƒˆã‚‚å…¨éƒ¨å¸ã„ä¸Šã’ã‚‹
    const existingBackups = new Set(caseObj.backupUnits);
    availableBackupUnits.forEach(unitName => {
      if (!existingBackups.has(unitName) && unitName !== caseObj.unit) {
        existingBackups.add(unitName);
        console.log('    â• è¿½åŠ :', unitName);
      }
    });
    caseObj.backupUnits = Array.from(existingBackups);

    console.log('  âœ… ç™ºä»¤å¾Œã®ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—:', caseObj.backupUnits);
    console.log('  ğŸ“ˆ è¿½åŠ ã•ã‚ŒãŸå°æ•°:', caseObj.backupUnits.length - beforeBackups.length);
    console.log('  ğŸ“Š åˆè¨ˆãƒ¦ãƒ‹ãƒƒãƒˆæ•°:', 1 + caseObj.backupUnits.length);
  }

  // ãƒãƒ¼ãƒ‰é·ç§»ã‚’åæ˜ 
  caseObj.currentNode = nextNode;
  caseObj.phase = nextNode.phase;

  // ãƒ¬ãƒ™ãƒ«ã‚¨ã‚¹ã‚«ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³
  if (nextNode.params && nextNode.params.escalate_level) {
    const newLevel = parseInt(nextNode.params.escalate_level, 10);
    if (!isNaN(newLevel)) {
      caseObj.level = newLevel;
      console.log('  â¬†ï¸ ãƒ¬ãƒ™ãƒ«ã‚¨ã‚¹ã‚«ãƒ¬ãƒ¼ãƒˆ:', newLevel);
    }
  }

  // add_units ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã§ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—éšŠã‚’è¿½åŠ 
  if (nextNode.params && nextNode.params.add_units) {
    const beforeAdd = [...caseObj.backupUnits];
    const newUnits = new Set(caseObj.backupUnits);

    nextNode.params.add_units.split(';').forEach(unitGroup => {
      unitGroup.split('ãƒ»').forEach(unitName => {
        const trimmedName = unitName.trim();
        if (trimmedName) newUnits.add(trimmedName);
      });
    });

    caseObj.backupUnits = Array.from(newUnits);
    console.log('  â• add_unitså‡¦ç†');
    console.log('    - å‡¦ç†å‰:', beforeAdd);
    console.log('    - å‡¦ç†å¾Œ:', caseObj.backupUnits);
  }

  // need-response=true ã®ã¨ãã¯å¿œç­”å¾…æ©Ÿã«ã™ã‚‹
  if (nextNode.params && nextNode.params['need-response'] === 'true') {
    caseObj.awaitingResponse = true;
    console.log('  â¸ å¿œç­”å¾…æ©ŸçŠ¶æ…‹ã«è¨­å®š');
  } else {
    caseObj.awaitingResponse = false;
  }

  // ç„¡ç·šãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã§ä½¿ã† context
  const context = {
    unit: caseObj.unit,
    zone: caseObj.zone,
    type_ja: caseObj.scenario.name,
    commander: commanderName
  };

  // {backup_unit} ã®åŸ‹ã‚è¾¼ã¿
  if (nextNode.message.includes('{backup_unit}')) {
    let unitToUse = null;

    if (caseObj.backupUnits && caseObj.backupUnits.length > 0) {
      // æ—¢ã«ã“ã®æ¡ˆä»¶ã«å¼µã‚Šä»˜ã„ã¦ã‚‹å¿œæ´ã‚’å‘¼ã¶
      unitToUse = caseObj.backupUnits[0];
      console.log('  ğŸ“‹ backup_unit context (æ—¢å­˜):', unitToUse);

    } else if (availableBackupUnits.length > 0) {
      // ã¾ã ä»˜ã„ã¦ãªã„ãªã‚‰ä»Šç©ºã„ã¦ã‚‹å¿œæ´ã‹ã‚‰æ–°è¦ã«å‰²ã‚Šå½“ã¦
      const selectedBackupUnit =
        availableBackupUnits[Math.floor(Math.random() * availableBackupUnits.length)];
      caseObj.backupUnits.push(selectedBackupUnit);
      unitToUse = selectedBackupUnit;
      console.log('  â• æ–°ã—ã„backup_unitã‚’å‰²ã‚Šå½“ã¦:', selectedBackupUnit);

    } else {
      console.warn(`  âš ï¸ backup_unitãŒå¿…è¦ã§ã—ãŸãŒã€å‰²ã‚Šå½“ã¦ã‚‰ã‚Œã¾ã›ã‚“ã§ã—ãŸã€‚ (Case: ${caseId}, Node: ${nextNode.phase})`);
    }

    context.backup_unit = unitToUse;

  } else if (caseObj.backupUnits && caseObj.backupUnits.length > 0) {
    // ã“ã®ãƒãƒ¼ãƒ‰è‡ªä½“ã¯ {backup_unit} ã‚’å«ã¾ãªã„ãŒã€
    // æ—¢ã«å¿œæ´ã¯ã„ã‚‹ã®ã§ã€ãã®éšŠåã‚’ context ã«å…¥ã‚Œã¦ãŠã
    context.backup_unit = caseObj.backupUnits[0];
  }

  // ãƒ†ãƒ³ãƒ—ãƒ¬å±•é–‹
  let message = this.parser.parse(nextNode.message, context);

  // backup-allæœ¬ä½“ãŒå‹•ã„ãŸã‚‰ã€ãã®æ´»å‹•æ™‚åˆ»ã‚’æ›´æ–°ï¼†è­¦å‘Šãƒ•ãƒ©ã‚°è§£é™¤
  if (this.isBackupAllActive && this.backupAllCaseId === caseId) {
    this.lastBackupAllActivity = Date.now();
    this.backupAllStallWarned = false;
  }

  console.log('  â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');
  console.log('  âœ… äº‹æ¡ˆé€²è¡Œå®Œäº†');
  console.log('  ğŸ“‹ äº‹æ¡ˆID:', caseId);
  console.log('  ğŸ“‹ ãƒ•ã‚§ãƒ¼ã‚º:', nextNode.phase);
  console.log('  ğŸ“‹ ãƒ—ãƒ©ã‚¤ãƒãƒªãƒ¦ãƒ‹ãƒƒãƒˆ:', caseObj.unit);
  console.log('  ğŸ“‹ ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ãƒ¦ãƒ‹ãƒƒãƒˆ:', caseObj.backupUnits);
  console.log('  ğŸ“‹ åˆè¨ˆãƒ¦ãƒ‹ãƒƒãƒˆæ•°:', 1 + caseObj.backupUnits.length);
  console.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');

  return {
    id: `N${String(this.nodeIdCounter++).padStart(6, '0')}`,
    caseId,
    level: caseObj.level,
    phase: nextNode.phase,
    zone: caseObj.zone,
    unit: caseObj.unit,
    message,
    scenarioName: caseObj.scenario.name,
    params: nextNode.params
  };
}
  getAllActiveCases() {
    return Array.from(this.activeCases.values()).filter(c => c.phase !== 'clear');
  }

  getVisibleCases() {
      return this.getAllActiveCases().filter(c => c.isVisible);
  }
}

// ==========================================
// UIæ›´æ–°
// ==========================================

// â–¼â–¼â–¼ã€å¤‰æ›´ã€‘requestAnimationFrameã‹ã‚‰setIntervalã«å¤‰æ›´ â–¼â–¼â–¼
let timerInterval = null;

function updateTimers() {
  // æ—¢å­˜ã®ã‚¿ã‚¤ãƒãƒ¼ãŒã‚ã‚Œã°åœæ­¢
  if (timerInterval) {
    clearInterval(timerInterval);
  }
  
  // setIntervalã§50msã”ã¨ã«æ›´æ–°
  timerInterval = setInterval(() => {
    const now = Date.now();
    document.querySelectorAll('.case-card[data-start-time]').forEach(card => {
      const timeEl = card.querySelector('.case-time');
      const startTime = parseInt(card.dataset.startTime, 10);
      
      if (timeEl && startTime) {
        const elapsedMs = now - startTime;
        const totalSeconds = Math.floor(elapsedMs / 1000);
        const minutes = Math.floor(totalSeconds / 60);
        const seconds = totalSeconds % 60;
        const centiseconds = Math.floor((elapsedMs % 1000) / 10);
        timeEl.textContent = `${minutes}:${String(seconds).padStart(2, '0')}.${String(centiseconds).padStart(2, '0')}`;
      }
    });
  }, 50);
  
  console.log('âœ… ã‚¿ã‚¤ãƒãƒ¼èµ·å‹•ï¼ˆsetIntervalç‰ˆï¼‰');
}

function stopTimers() {
  if (timerInterval) {
    clearInterval(timerInterval);
    timerInterval = null;
    console.log('â¹ï¸ ã‚¿ã‚¤ãƒãƒ¼åœæ­¢');
  }
}
// â–²â–²â–²ã€å¤‰æ›´ã“ã“ã¾ã§ã€‘â–²â–²â–²
function updateCaseStatus() {
  const el = document.getElementById("caseList");
  if (!scenarioEngine) {
    el.innerHTML = '<div class="no-cases">CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã‚“ã§ãã ã•ã„</div>';
    return;
  }
  
  const active = scenarioEngine.getVisibleCases();
  if (active.length === 0) {
    el.innerHTML = '<div class="no-cases">ç¾åœ¨ã€é€²è¡Œä¸­ã®äº‹æ¡ˆã¯ã‚ã‚Šã¾ã›ã‚“</div>';
    return;
  }

  active.sort((a, b) => b.level - a.level);
  
  // æ—¢å­˜ã®ã‚«ãƒ¼ãƒ‰ã‚’Mapã§ç®¡ç†
  const existingCardsMap = new Map();
  el.querySelectorAll('.case-card').forEach(card => {
    const caseId = card.querySelector('.case-id')?.textContent;
    if (caseId) {
      existingCardsMap.set(caseId, card);
    }
  });
  
  const fragment = document.createDocumentFragment();
  
  active.forEach(c => {
    const allUnits = [c.unit, ...c.backupUnits].filter(u => u);
    const unitsStr = allUnits.join('ãƒ»');
    const levelClass = `lv${c.level}`;
    
    let card = existingCardsMap.get(c.id);
    
    if (card) {
      // æ—¢å­˜ã‚«ãƒ¼ãƒ‰ã‚’æ›´æ–°ï¼ˆcase-timeä»¥å¤–ï¼‰
      card.querySelector('.level-badge').className = `level-badge ${levelClass}`;
      card.querySelector('.level-badge').textContent = `LV${c.level}`;
      card.querySelector('.case-type').textContent = c.scenario.name;
      card.querySelector('.case-info-row:nth-child(1) .info-value').textContent = c.zone;
      card.querySelector('.case-info-row:nth-child(2) .info-value').textContent = c.phase;
      card.querySelector('.case-units').textContent = unitsStr;
      // â˜… case-timeã¯è§¦ã‚‰ãªã„ï¼updateTimers()ã«ä»»ã›ã‚‹ â˜…
      
      existingCardsMap.delete(c.id);
    } else {
      // æ–°è¦ã‚«ãƒ¼ãƒ‰ã‚’ä½œæˆ
      card = document.createElement('div');
      card.className = 'case-card';
      card.setAttribute('data-start-time', c.startTime);
      card.innerHTML = `
        <div class="case-header">
          <span class="level-badge ${levelClass}">LV${c.level}</span>
          <span class="case-id">${c.id}</span>
          <span class="case-type">${c.scenario.name}</span>
        </div>
        <div class="case-body">
          <div class="case-info-row"><span class="info-label">åœ°åŒº:</span><span class="info-value">${c.zone}</span></div>
          <div class="case-info-row"><span class="info-label">çŠ¶æ…‹:</span><span class="info-value">${c.phase}</span></div>
        </div>
        <div class="case-footer">
          <span class="case-units">${unitsStr}</span>
          <span class="case-time">0:00.00</span>
        </div>
      `;
    }
    
    fragment.appendChild(card);
  });
  
  el.innerHTML = '';
  el.appendChild(fragment);
}

// ==========================================
// ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£
// ==========================================

const sleep = ms => new Promise(r => setTimeout(r, ms));

async function typeOut(seed, cpsBase, ev, msgEl) {
  const pauses = { ",": 120, "ã€": 160, ".": 180, "ã€‚": 220, " ": 50 };
  const base = 1000 / cpsBase;
  msgEl.textContent = "";

  for (let i = 0; i < ev.message.length; i++) {
    const ch = ev.message[i];
    let extra = pauses[ch] || 0;
    await sleep(base + extra);
    msgEl.textContent += ch;
  }
}

// ==========================================
// éŸ³å£°é–¢é€£
// ==========================================

function ensureAudio() {
  if (!audioCtx) {
    audioCtx = new (window.AudioContext || window.webkitAudioContext)();

    masterGain   = audioCtx.createGain();
    timeSigGain  = audioCtx.createGain(); // â˜… æ™‚å ±ç”¨
    sfxGain      = audioCtx.createGain();
    noiseGain    = audioCtx.createGain();

    // ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°
    timeSigGain.connect(masterGain); // æ™‚å ±ã¯ã“ã“ã¸
    sfxGain.connect(masterGain);     // åŠ¹æœéŸ³
    noiseGain.connect(masterGain);   // ç„¡ç·šãƒã‚¤ã‚º
    masterGain.connect(audioCtx.destination);

    // ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ç¾åœ¨å€¤ã‚’åæ˜ 
    const masterVol   = parseFloat(document.getElementById("masterVolumeSlider").value);
    const timeSigVol  = parseFloat(document.getElementById("timeSigVolumeSlider").value || "0.5");
    const sfxVol      = parseFloat(document.getElementById("sfxVolumeSlider").value);
    const noiseVol    = parseFloat(document.getElementById("noiseVolumeSlider").value);

    masterGain.gain.setValueAtTime(masterVol,  audioCtx.currentTime);
    timeSigGain.gain.setValueAtTime(timeSigVol, audioCtx.currentTime);
    sfxGain.gain.setValueAtTime(sfxVol,        audioCtx.currentTime);
    noiseGain.gain.setValueAtTime(noiseVol,    audioCtx.currentTime);
  }

  if (audioCtx.state === "suspended") {
    audioCtx.resume();
  }
}

function playChirp(type) {
  if (!audioCtx) return;
  const t0 = audioCtx.currentTime;
  const osc = audioCtx.createOscillator();
  const gain = audioCtx.createGain();
  osc.type = 'triangle';
  gain.gain.value = 0;

  const vol = 0.05; // åŸºæº–éŸ³é‡

  if (type === 'start') {
    osc.frequency.setValueAtTime(250, t0 + 0.12);
    gain.gain.linearRampToValueAtTime(vol, t0 + 0.13);
    gain.gain.linearRampToValueAtTime(0, t0 + 0.17);
    osc.frequency.setValueAtTime(750, t0 + 0.06);
    gain.gain.linearRampToValueAtTime(vol, t0 + 0.07);
    gain.gain.linearRampToValueAtTime(0, t0 + 0.11);
  } else if (type === 'end') {
    osc.frequency.setValueAtTime(1500, t0);
    gain.gain.linearRampToValueAtTime(vol, t0 + 0.01);
    gain.gain.linearRampToValueAtTime(0, t0 + 0.05);
    osc.frequency.setValueAtTime(750, t0 + 0.06);
    gain.gain.linearRampToValueAtTime(vol, t0 + 0.07);
    gain.gain.linearRampToValueAtTime(0, t0 + 0.11);
    osc.frequency.setValueAtTime(250, t0 + 0.12);
    gain.gain.linearRampToValueAtTime(vol, t0 + 0.13);
    gain.gain.linearRampToValueAtTime(0, t0 + 0.17);
  }

  osc.connect(gain);
  // â–¼â–¼â–¼ã€å¤‰æ›´ç‚¹ã€‘æ¥ç¶šå…ˆã‚’sfxGainãƒŸã‚­ã‚µãƒ¼ã«å¤‰æ›´ â–¼â–¼â–¼
  gain.connect(sfxGain);
  // â–²â–²â–²ã€å¤‰æ›´ç‚¹ã€‘â–²â–²â–²
  osc.start(t0);
  osc.stop(t0 + 0.2);
}

function startWhiteNoise() {
  if (!audioCtx || whiteNoiseNode) return;
  
  const bufferSize = audioCtx.sampleRate * 1;
  const buffer = audioCtx.createBuffer(1, bufferSize, audioCtx.sampleRate);
  const output = buffer.getChannelData(0);
  for (let i = 0; i < bufferSize; i++) {
    output[i] = Math.random() * 2 - 1;
  }

  whiteNoiseNode = audioCtx.createBufferSource();
  whiteNoiseNode.buffer = buffer;
  whiteNoiseNode.loop = true;
  
  const gainNode = audioCtx.createGain();
  const lowPassFilter = audioCtx.createBiquadFilter();
  lowPassFilter.type = 'lowpass';
  lowPassFilter.frequency.value = 1500;
  const highPassFilter = audioCtx.createBiquadFilter();
  highPassFilter.type = 'highpass';
  highPassFilter.frequency.value = 500;

  whiteNoiseNode.connect(highPassFilter);
  highPassFilter.connect(lowPassFilter);
  lowPassFilter.connect(gainNode);
  // â–¼â–¼â–¼ã€å¤‰æ›´ç‚¹ã€‘æ¥ç¶šå…ˆã‚’noiseGainãƒŸã‚­ã‚µãƒ¼ã«å¤‰æ›´ â–¼â–¼â–¼
  gainNode.connect(noiseGain);
  // â–²â–²â–²ã€å¤‰æ›´ç‚¹ã€‘â–²â–²â–²
  
  gainNode.gain.setValueAtTime(0, audioCtx.currentTime);
  // ãƒ•ã‚§ãƒ¼ãƒ‰ã‚¤ãƒ³ã¯ã“ã“ã§è¡Œã†ï¼ˆåŸºæº–éŸ³é‡ã¾ã§ï¼‰
  gainNode.gain.linearRampToValueAtTime(0.01, audioCtx.currentTime + 1);
  
  whiteNoiseNode.start();
}

function stopWhiteNoise() {
  return new Promise(resolve => {
    if (!whiteNoiseNode) {
      resolve();
      return;
    }
    // å³æ™‚åœæ­¢ã§ã¯ãªãã€ãƒ•ã‚§ãƒ¼ãƒ‰ã‚¢ã‚¦ãƒˆã•ã›ã‚‹ãŸã‚ã«æ–°ã—ã„GainNodeã‚’ä½¿ã†
    const fadeOutGain = audioCtx.createGain();
    fadeOutGain.connect(noiseGain); // æ¥ç¶šå…ˆã¯noiseGainã®ã¾ã¾
    
    const currentGain = 0.01; // startWhiteNoiseã®æœ€å¤§éŸ³é‡ã«åˆã‚ã›ã‚‹
    fadeOutGain.gain.setValueAtTime(currentGain, audioCtx.currentTime);
    fadeOutGain.gain.linearRampToValueAtTime(0, audioCtx.currentTime + 0.05);

    try {
        whiteNoiseNode.disconnect();
        whiteNoiseNode.connect(fadeOutGain);
    } catch (e) { /* ignore */ }

    setTimeout(() => {
      try {
        whiteNoiseNode.stop();
      } catch (e) { /* ignore */ }
      whiteNoiseNode = null;
      resolve();
    }, 50);
  });
}

function toneNTT(kind) {
  if (!TTS_ENABLED || !audioCtx) return;

  const p = {
    pip:  { f: 2000, dur: 4,   g: 0.03, atk: 0.001, dec: 0.030, rel: 0.030, h2: 0.3 },
    pop:  { f: 500,  dur: 100, g: 0.06, atk: 0.001, dec: 0.050, rel: 0.060, h2: 1   },
    peen: { f: 1000, dur: 600, g: 0.06, atk: 0.003, dec: 0.01,  rel: 0.003, h2: 1   }
  }[kind];

  const ctx = audioCtx;
  const t0 = ctx.currentTime;

  const osc = ctx.createOscillator();
  osc.type = 'square';
  osc.frequency.value = p.f;

  const gain = ctx.createGain();
  gain.gain.value = 0;

  const filter = ctx.createBiquadFilter();
  filter.type = 'lowpass';
  filter.frequency.value = p.f * 1.4;

  osc.connect(filter);
  filter.connect(gain);

  // â˜… ã“ã“ãŒå¤‰æ›´ãƒã‚¤ãƒ³ãƒˆï¼šæ™‚å ±å°‚ç”¨ã®ãƒã‚¹ã¸
  gain.connect(timeSigGain);

  // ã‚¨ãƒ³ãƒ™ãƒ­ãƒ¼ãƒ—
  const g = gain.gain;
  g.setValueAtTime(0, t0);
  g.linearRampToValueAtTime(p.g,           t0 + p.atk);
  g.linearRampToValueAtTime(p.g * 0.8,     t0 + p.atk + p.dec);
  g.linearRampToValueAtTime(0.0001,        t0 + (p.dur / 1000) + p.rel);

  osc.start(t0);
  osc.stop(t0 + (p.dur / 1000) + p.rel + 0.05);
}
// â–¼â–¼â–¼ã€å¤‰æ›´ã€‘å¼•æ•°ã«showOverlayã‚’è¿½åŠ  â–¼â–¼â–¼
function playEmergencyBeep(durationMs, showOverlay = true) {
  if (!TTS_ENABLED || !audioCtx) return Promise.resolve();
  ensureAudio();

  // â–¼â–¼â–¼ã€å¤‰æ›´ã€‘showOverlayãŒtrueã®æ™‚ã®ã¿è­¦å‘Šç”»é¢ã‚’è¡¨ç¤º â–¼â–¼â–¼
  const overlay = document.getElementById('emergency-overlay');
  if (showOverlay) {
    overlay.classList.add('active');
  }
  // â–²â–²â–²ã€å¤‰æ›´ã€‘ã“ã“ã¾ã§ â–²â–²â–²

  return new Promise(resolve => {
    const t0 = audioCtx.currentTime;
    const durationSec = durationMs / 1000;

    const mainGain = audioCtx.createGain();
    mainGain.connect(sfxGain);
    mainGain.gain.value = 0;

    const osc1 = audioCtx.createOscillator();
    const osc2 = audioCtx.createOscillator();
    osc1.type = 'sine';
    osc2.type = 'sine';
    osc1.frequency.setValueAtTime(1000, t0);
    osc2.frequency.setValueAtTime(1030, t0);
    osc1.connect(mainGain);
    osc2.connect(mainGain);

    const attackTime = 0.005;
    const releaseTime = 0.01;
    const vol = 0.02; // åŸºæº–éŸ³é‡
    mainGain.gain.linearRampToValueAtTime(vol, t0 + attackTime);
    mainGain.gain.setValueAtTime(vol, t0 + durationSec - releaseTime);
    mainGain.gain.linearRampToValueAtTime(0, t0 + durationSec);

    osc1.start(t0);
    osc2.start(t0);
    osc1.stop(t0 + durationSec);
    osc2.stop(t0 + durationSec);

    osc2.onended = () => {
      // â–¼â–¼â–¼ã€å¤‰æ›´ã€‘showOverlayãŒtrueã®æ™‚ã®ã¿è­¦å‘Šç”»é¢ã‚’éè¡¨ç¤º â–¼â–¼â–¼
      if (showOverlay) {
        overlay.classList.remove('active');
      }
      // â–²â–²â–²ã€å¤‰æ›´ã€‘ã“ã“ã¾ã§ â–²â–²â–²
      resolve();
    };
  });
}
function startTimeSignal() {
  if (tickTimer) clearTimeout(tickTimer);
  if (!TTS_ENABLED) return;
  ensureAudio();

  const tick = () => {
    if (!TTS_ENABLED) { 
      tickTimer = null;
      return;
    }
    const s = new Date().getSeconds();
    if (s % 10 === 0) { toneNTT('peen'); }
    else if (s >= 57) { toneNTT('pop'); }
    else { toneNTT('pip'); }
    const delay = 1000 - new Date().getMilliseconds();
    tickTimer = setTimeout(tick, delay);
  };
  const firstDelay = 1000 - new Date().getMilliseconds();
  tickTimer = setTimeout(tick, firstDelay);
}

function stopTimeSignal() {
  if (tickTimer) {
    clearTimeout(tickTimer);
    tickTimer = null;
  }
}

// ==========================================
// æ™‚è¨ˆ
// ==========================================
(function () {
  const el = document.getElementById("jst");
  function pad(n, len = 2) { return String(n).padStart(len, "0"); }
  function tick() {
    const now = new Date();
    const ms = String(now.getMilliseconds()).padStart(3, '0');
    el.textContent = `${pad(now.getHours())}:${pad(now.getMinutes())}:${pad(now.getSeconds())}.${ms}`;
  }
  tick();
  setInterval(tick, 50);
})();

// ==========================================
// è‡ªå‹•ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«åˆ¶å¾¡
// ==========================================
(function() {
  const log = document.getElementById("log");
  let scrollAnimationFrame = null;
  const SCROLL_SPEED = 0.5; // ãƒ”ã‚¯ã‚»ãƒ«/ãƒ•ãƒ¬ãƒ¼ãƒ ï¼ˆã“ã®å€¤ã‚’èª¿æ•´ã—ã¦é€Ÿåº¦å¤‰æ›´ï¼‰
  let userScrolling = false;
  let scrollTimeout = null;
  let isAutoScrolling = false;
 
  function smoothScrollToBottom() {
    if (userScrolling) return;
    
    isAutoScrolling = true;
    const targetScroll = log.scrollHeight - log.clientHeight;
    const currentScroll = log.scrollTop;
    const distance = targetScroll - currentScroll;
   
    if (Math.abs(distance) < 1) {
      log.scrollTop = targetScroll;
      scrollAnimationFrame = null;
      isAutoScrolling = false;
      return;
    }
   
    // ä¸€å®šé€Ÿåº¦ã§ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ï¼ˆé€Ÿåº¦ã¯å›ºå®šï¼‰
    log.scrollTop = currentScroll + Math.min(SCROLL_SPEED, distance);
   
    scrollAnimationFrame = requestAnimationFrame(smoothScrollToBottom);
  }
 
  function resetAutoScroll() {
    userScrolling = false;
    if (scrollAnimationFrame) {
      cancelAnimationFrame(scrollAnimationFrame);
    }
   
    // é€Ÿåº¦è¨ˆç®—ã›ãšã€å›ºå®šé€Ÿåº¦ã§ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«é–‹å§‹
    smoothScrollToBottom();
  }
  
  // æ–°ã—ã„ãƒ­ã‚°ãŒè¿½åŠ ã•ã‚ŒãŸã¨ãã®å‡¦ç†
  const observer = new MutationObserver(() => {
    // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ä¸­ã§ãªãã€ã‹ã¤æ—¢ã«è‡ªå‹•ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ä¸­ãªã‚‰ç¶™ç¶š
    // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ä¸­ã§ãªãã€è‡ªå‹•ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã‚‚ã—ã¦ã„ãªã‘ã‚Œã°é–‹å§‹
    if (!userScrolling && !scrollAnimationFrame) {
      smoothScrollToBottom();
    }
    // æ—¢ã«ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ä¸­ãªã‚‰ä½•ã‚‚ã—ãªã„ï¼ˆå›ºå®šé€Ÿåº¦ã‚’ç¶­æŒï¼‰
  });
  
  observer.observe(log, { childList: true, subtree: true });
 
  log.addEventListener('wheel', () => {
    userScrolling = true;
    clearTimeout(scrollTimeout);
    if (scrollAnimationFrame) {
      cancelAnimationFrame(scrollAnimationFrame);
      scrollAnimationFrame = null;
    }
    isAutoScrolling = false;
    scrollTimeout = setTimeout(resetAutoScroll, 5000);
  });
 
  let touchStartY = 0;
  let hasMoved = false;

  // touchstartã§ã¯ userScrolling = true ã«ã—ãªã„ï¼
  log.addEventListener('touchstart', (e) => {
    touchStartY = e.touches[0].clientY;
    hasMoved = false;
    // userScrolling ã¯ã“ã“ã§è¨­å®šã—ãªã„
  });

  // touchmoveã§å®Ÿéš›ã«ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã—ãŸæ™‚ã ã‘è¨­å®š
  log.addEventListener('touchmove', (e) => {
    const deltaY = e.touches[0].clientY - touchStartY;
    if (Math.abs(deltaY) > 5) { // 5pxä»¥ä¸Šã®ç§»å‹•ã§ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã¨ã¿ãªã™
      userScrolling = true;  // â† ã“ã“ã§åˆã‚ã¦è¨­å®š
      hasMoved = true;
    }
  });

  // touchendã§ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã—ã¦ã„ãªã„å ´åˆã¯ä½•ã‚‚ã—ãªã„
  log.addEventListener('touchend', () => {
    if (hasMoved) {  // â† ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã—ãŸå ´åˆã®ã¿
      clearTimeout(scrollTimeout); // æ—¢å­˜ã®ã‚¿ã‚¤ãƒãƒ¼ã‚’ã‚¯ãƒªã‚¢
      scrollTimeout = setTimeout(resetAutoScroll, 5000);
    }
    // ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã—ã¦ãªã‘ã‚Œã°è‡ªå‹•ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ç¶™ç¶š
  });
 
  log.addEventListener('mousedown', () => { // ãƒã‚¦ã‚¹ãƒ‰ãƒ©ãƒƒã‚°é–‹å§‹
      userScrolling = true;
      clearTimeout(scrollTimeout);
      if (scrollAnimationFrame) {
          cancelAnimationFrame(scrollAnimationFrame);
          scrollAnimationFrame = null;
      }
      isAutoScrolling = false;
  });

  log.addEventListener('mouseup', () => {
    clearTimeout(scrollTimeout);
    scrollTimeout = setTimeout(resetAutoScroll, 5000);
  });
})();
// ==========================================
// éŸ³å£°åˆæˆï¼ˆTTSï¼‰
// ==========================================

function loadVoices() {
  if (!('speechSynthesis' in window)) return;
  const load = () => {
    const vs = speechSynthesis.getVoices();
    const sel = document.getElementById("voiceSel");
    sel.innerHTML = '<option value="">å£°ã®ç¨®é¡</option>';
    vs.forEach((v, i) => {
      const o = document.createElement('option');
      o.value = String(i); o.textContent = `${v.name} (${v.lang})`;
      sel.appendChild(o);
    });
    const jaVoice = vs.find(v => /^ja/i.test(v.lang)) || vs[0];
    chosenVoice = jaVoice;
  };
  load();
  speechSynthesis.onvoiceschanged = load;
}
loadVoices();

async function speakMessage(text, isTest = false) {
  return new Promise((resolve, reject) => {
    setTimeout(async () => {
      if (!('speechSynthesis' in window)) {
        resolve();
        return;
      }

      // ğŸ”½ ã“ã“ã‚’è¿½åŠ 
      if (!chosenVoice) {
        const voicesRetry = speechSynthesis.getVoices();
        if (voicesRetry.length > 0) {
          chosenVoice =
            voicesRetry.find(v => /^ja/i.test(v.lang)) ||
            voicesRetry[0] ||
            null;
        }
      }
      // ğŸ”¼ ã“ã“ã¾ã§è¿½åŠ 

      const masterVol = masterGain
        ? masterGain.gain.value
        : parseFloat(document.getElementById("masterVolumeSlider").value);

      const utter = new SpeechSynthesisUtterance(text);
      utter.voice = chosenVoice || null; // nullã§ã‚‚OKã€OSãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§èª­ã‚“ã§ãã‚Œã‚‹
      utter.rate = ttsRate;
      utter.volume = ttsVolume * masterVol;

      utter.onend = resolve;
      utter.onerror = (e) => {
        if (e.error === 'interrupted') {
          resolve();
        } else {
          console.error("SpeechSynthesisUtterance.onerror", e);
          reject(e);
        }
      };

      setTimeout(() => {
        speechSynthesis.speak(utter);
      }, 50);
    }, 50);
  });
}


/// ==========================================
// ãƒ¡ã‚¤ãƒ³ãƒ«ãƒ¼ãƒ—
// ==========================================

async function runSystem() {
  if (!scenarioEngine) {
    alert('CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’å…ˆã«èª­ã¿è¾¼ã‚“ã§ãã ã•ã„');
    return;
  }
  const status = document.getElementById("status");
  const log = document.getElementById("log");
  const my = ++runningToken;
  log.innerHTML = "";
  scenarioEngine.activeCases.clear();
  scenarioEngine.caseIdCounter = 1;
  scenarioEngine.nodeIdCounter = 1;
  // ã‚·ã‚¹ãƒ†ãƒ é–‹å§‹æ™‚ã«backup-allçŠ¶æ…‹ã‚’ãƒªã‚»ãƒƒãƒˆ
  if (scenarioEngine) {
    scenarioEngine.isBackupAllActive = false;
    scenarioEngine.backupAllCaseId = null;
  }
  status.textContent = "ACTIVE";
  
  let pendingResponseCaseId = null; 

  async function processAndDisplayEvent(event) {
  if (!event) return;
  
  const randomDelay = Math.random() * 2000 + 2000;
  await sleep(randomDelay);

  const caseObj = scenarioEngine.activeCases.get(event.caseId);
  const isNewCase = caseObj && !caseObj.isVisible;

  // â˜…â˜…â˜… ä¿®æ­£ï¼šæ–°è¦äº‹æ¡ˆã®å ´åˆã¯ã€ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤ºå‰ã«CasePanelã‚’æ›´æ–°ã—ãªã„ â˜…â˜…â˜…
  if (!isNewCase) {
      updateCaseStatus();
  }

  const row = document.createElement("div");
  row.className = "radio-message";
  if (event.params && event.params.alert === 'beep') {
    row.classList.add('alert');
  }
  const meta = document.createElement("div");
  meta.className = "radio-message-meta";
  const ts = document.createElement("div");
  ts.className = "msg-time";
  const ts_now = new Date();
  ts.textContent = ts_now.toLocaleTimeString("ja-JP", { hour12: false, hour: '2-digit', minute: '2-digit', second: '2-digit' });
  const ch = document.createElement("div");
  ch.className = `msg-level lv${event.level}`;
  ch.textContent = `LV${event.level}`;
  const caseTag = document.createElement("div");
  caseTag.className = "msg-case";
  caseTag.textContent = event.caseId;
  meta.append(ts, ch, caseTag);
  const msg = document.createElement("div");
  msg.className = "msg-content";
  row.append(meta, msg);
  log.appendChild(row);

  if (event.params && event.params.alert === 'beep' && TTS_ENABLED) {
      await playEmergencyBeep(3000);
      await sleep(500);
  }
  if (TTS_ENABLED) {
    ensureAudio();
    playChirp('start');
    startWhiteNoise();
  }
  
  // â˜…â˜…â˜… å‰Šé™¤ï¼šã“ã“ã§isNewCaseã®å‡¦ç†ã‚’ã—ãªã„ï¼ˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤ºå¾Œã«ç§»å‹•ï¼‰â˜…â˜…â˜…
  // if (isNewCase) {
  //     caseObj.isVisible = true;
  //     updateCaseStatus();
  // }

  // â˜…â˜…â˜… ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤ºï¼ˆtypeOut + TTSï¼‰ â˜…â˜…â˜…
  if (TTS_ENABLED) {
    await Promise.all([
      typeOut("", BASE_CPS, event, msg),
      speakMessage(event.message)
    ]);
  } else {
    await typeOut("", BASE_CPS, event, msg);
  }
  if (TTS_ENABLED) {
    await stopWhiteNoise();
    if (TTS_ENABLED) {
      playChirp('end');
    }
  }

  // â˜…â˜…â˜… è¿½åŠ ï¼šãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤ºå®Œäº†å¾Œã«æ–°è¦äº‹æ¡ˆã‚’CasePanelã«è¡¨ç¤º â˜…â˜…â˜…
  if (isNewCase) {
      caseObj.isVisible = true;
      updateCaseStatus();
  }

  if (event.params && event.params['need-response'] === 'true') {
      pendingResponseCaseId = event.caseId;
  }

  // â˜…â˜…â˜… è¿½åŠ ï¼šæ—¢å­˜äº‹æ¡ˆã®å ´åˆã‚‚ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤ºå¾Œã«CasePanelã‚’æ›´æ–° â˜…â˜…â˜…
  // ï¼ˆbackup-allé€”ä¸­ç™ºä»¤ãªã©ã§å¤‰æ›´ãŒã‚ã£ãŸå ´åˆã«åæ˜ ï¼‰
  if (!isNewCase) {
      updateCaseStatus();
  }

  // â–¼â–¼â–¼ã€å¤‰æ›´ã€‘clear=trueé–¢é€£ã®ãƒ­ã‚¸ãƒƒã‚¯ã‚’ã™ã¹ã¦å‰Šé™¤ â–¼â–¼â–¼
  // (çµ‚äº†å‡¦ç†ã¯ progressCase å†…ã«ç§»å‹•ã—ãŸãŸã‚)
  // â–²â–²â–²ã€å¤‰æ›´ã“ã“ã¾ã§ã€‘â–²â–²â–²
  
}

  updateCaseStatus();

  while (my === runningToken) {
    let eventToProcess = null;
    
    // â–¼â–¼â–¼ã€ä¿®æ­£ã€‘busyUnits ã®è¨ˆç®—ãƒ­ã‚¸ãƒƒã‚¯ã‚’ä¿®æ­£ â–¼â–¼â–¼
    const busyUnits = new Set();
    for (const caseObj of scenarioEngine.activeCases.values()) {
        busyUnits.add(caseObj.unit);
        // forEach ã‚’ä½¿ã£ã¦å…¨ãƒ¦ãƒ‹ãƒƒãƒˆã‚’ Set ã«è¿½åŠ 
        caseObj.backupUnits.forEach(unit => busyUnits.add(unit));
    }
    // â–²â–²â–²ã€ä¿®æ­£ã“ã“ã¾ã§ã€‘â–²â–²â–²
    
    if (pendingResponseCaseId) {
      eventToProcess = scenarioEngine.progressCase(pendingResponseCaseId, busyUnits);
      if (eventToProcess) {
        pendingResponseCaseId = null;
      }
    } 
    
    if (!eventToProcess) {
      const activeCases = scenarioEngine.getVisibleCases();
      const activeCaseCount = activeCases.length;

      if (activeCaseCount < 5 && Math.random() < 0.5 ) {
        eventToProcess = scenarioEngine.generateNewCase(busyUnits);
      }

      if (!eventToProcess && activeCaseCount > 0) {
        let caseIdToProgress = null;
        activeCases.sort((a, b) => a.startTime - b.startTime);
        
        const oldestCase = activeCases[0];
        const otherCases = activeCases.slice(1);

        if (Math.random() < 0.1) {
          caseIdToProgress = oldestCase.id;
        } else {
          if (otherCases.length > 0) {
            const randomOtherCase = otherCases[Math.floor(Math.random() * otherCases.length)];
            caseIdToProgress = randomOtherCase.id;
          } else {
            caseIdToProgress = oldestCase.id;
          }
        }
        
        if (caseIdToProgress) {
            eventToProcess = scenarioEngine.progressCase(caseIdToProgress, busyUnits);
        }
      }
    }

    if (eventToProcess) {
      await processAndDisplayEvent(eventToProcess);
    } else {
      updateCaseStatus();
      await sleep(1000); 
    }
  }
}

// ==========================================
// ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
// ==========================================
function initializeSystem(csvText) {
  // ã‚·ãƒŠãƒªã‚ªãƒ­ãƒ¼ãƒ€ãƒ¼ã‚’ä½œæˆã—ã¦ CSV ã‚’ãƒ‘ãƒ¼ã‚¹
  scenarioLoader = new ScenarioLoader();
  try { // â˜…â˜…â˜… ãƒ‘ãƒ¼ã‚¹å¤±æ•—ã‚’ã‚­ãƒ£ãƒƒãƒ â˜…â˜…â˜…
    scenarioLoader.parseCSV(csvText);  // PARAM/LEVEL/NODE ã‚’å–ã‚Šè¾¼ã‚€
  } catch (e) {
    console.error("CSVã®ãƒ‘ãƒ¼ã‚¹ã«å¤±æ•—:", e);
    document.getElementById("caseList").innerHTML =
      '<div class="no-cases">âŒ CSVã®è§£æã«å¤±æ•—ã—ã¾ã—ãŸã€‚æ›¸å¼ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚</div>';
    return; // â˜…â˜…â˜…ã“ã“ã§ä¸­æ–­
  }

  // ãƒ¦ãƒ‹ãƒƒãƒˆç¨®åˆ¥ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’æ§‹ç¯‰ï¼ˆCSVã® PARAM lists ã‚’åˆ©ç”¨ï¼‰
  const unitTypes = {
    investigation: scenarioLoader.paramLists.units_investigation || [],
    traffic:       scenarioLoader.paramLists.units_traffic       || [],
    patrol:        scenarioLoader.paramLists.units_patrol        || [],
    backup:        scenarioLoader.paramLists.units_backup        || []
  };

  console.log('--- DEBUG: initializeSystem ---');
  console.log('èª­ã¿è¾¼ã¾ã‚ŒãŸ unitTypes.backup:', unitTypes.backup);
  console.log('---------------------------------');

  // ã‚¨ãƒ³ã‚¸ãƒ³ã‚’åˆæœŸåŒ–
  scenarioEngine = new ScenarioEngine(scenarioLoader, unitTypes);

  // UI: å†èª­ã¿è¾¼ã¿ãƒœã‚¿ãƒ³ã‚’æœ‰åŠ¹åŒ–ã—ã€æ¡ˆå†…ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
  document.getElementById("syncBtn").disabled = false;
  document.getElementById("caseList").innerHTML =
    '<div class="no-cases">âœ… ã‚·ãƒŠãƒªã‚ªèª­è¾¼å®Œäº†ã€‚ã‚·ã‚¹ãƒ†ãƒ ã‚’èµ·å‹•ã—ã¦ãã ã•ã„</div>';
}

// ==========================================
// DOMContentLoaded - åˆæœŸåŒ–ã¨è‡ªå‹•èµ·å‹•
// ==========================================
window.addEventListener('DOMContentLoaded', async () => {
  // --- 1. è¨­å®šã‚’å¾©å…ƒ ---
  loadSettings();

  // --- 2. UIã‚¤ãƒ™ãƒ³ãƒˆ ---
  const commanderInput = document.getElementById("commanderInput");
  commanderInput.addEventListener('input', (e) => {
    const newName = e.target.value.trim();
    commanderName = newName || "æœ¬éƒ¨";
    systemTitle.textContent = `${commanderName}é€šä¿¡æŒ‡ä»¤ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿`;
    saveSettings();
  });

  const specialAlertModeBtn = document.getElementById("specialAlertModeToggle");
  if (specialAlertModeBtn) {
    specialAlertModeBtn.addEventListener("click", () => {
      isSpecialAlertMode = !isSpecialAlertMode;
      specialAlertModeBtn.textContent = `ãƒ‰ãƒ©ãƒãƒãƒƒã‚¯ãƒ¢ãƒ¼ãƒ‰: ${isSpecialAlertMode ? "ON" : "OFF"}`;
      specialAlertModeBtn.classList.toggle("active", isSpecialAlertMode);
      saveSettings();
      if (TTS_ENABLED) {
        ensureAudio();
        if (isSpecialAlertMode) { playEmergencyBeep(400, false); }
        else { playChirp('end'); }
      }
    });
  }

  document.getElementById("toggleControls").addEventListener("click", () => {
    document.getElementById("controlPanel").classList.toggle("is-open");
  });
  document.getElementById("closeControlsBtn").addEventListener("click", () => {
    document.getElementById("controlPanel").classList.remove("is-open");
  });

  document.getElementById("voiceSel").addEventListener('change', () => {
    const vs = speechSynthesis.getVoices();
    const i = parseInt(document.getElementById("voiceSel").value);
    chosenVoice = Number.isInteger(i) ? vs[i] : vs.find(v => /^ja/i.test(v.lang));
    saveSettings();
  });

  const rateSlider = document.getElementById("rateSlider");
  rateSlider.addEventListener('input', (e) => {
    ttsRate = parseFloat(e.target.value);
    document.getElementById("rateValue").textContent = ttsRate.toFixed(1);
    saveSettings();
  });
  rateSlider.addEventListener('change', () => {
    if ('speechSynthesis' in window) {
      speechSynthesis.cancel();
      speakMessage("é€Ÿåº¦ãƒ†ã‚¹ãƒˆ", true);
    }
  });

  document.getElementById("masterVolumeSlider").addEventListener('input', (e) => {
    const vol = parseFloat(e.target.value);
    document.getElementById("masterVolumeValue").textContent = vol.toFixed(2);
    if (masterGain) {
      masterGain.gain.setTargetAtTime(vol, audioCtx.currentTime, 0.01);
    }
    saveSettings();
  });

  const sfxSlider = document.getElementById("sfxVolumeSlider");
  sfxSlider.addEventListener('input', (e) => {
    const vol = parseFloat(e.target.value);
    document.getElementById("sfxVolumeValue").textContent = vol.toFixed(2);
    if (sfxGain) {
      sfxGain.gain.setTargetAtTime(vol, audioCtx.currentTime, 0.01);
    }
    saveSettings();
  });
  sfxSlider.addEventListener('change', () => {
    ensureAudio();
    playEmergencyBeep(1000, false);
  });

  const timeSigSlider = document.getElementById("timeSigVolumeSlider");
  timeSigSlider.addEventListener('input', (e) => {
    const vol = parseFloat(e.target.value);
    document.getElementById("timeSigVolumeValue").textContent = vol.toFixed(2);
    if (timeSigGain) {
      timeSigGain.gain.setTargetAtTime(vol, audioCtx.currentTime, 0.01);
    }
    saveSettings();
  });
  timeSigSlider.addEventListener('change', () => {
    // TTSãŒONã®ã¨ãã ã‘ã€"ãƒ”ãƒƒ" ã‚’1å›é³´ã‚‰ã—ã¦ç¢ºèªã§ãã‚‹ã‚ˆã†ã«ã™ã‚‹
    ensureAudio();
    toneNTT('pip');
  });

  document.getElementById("noiseVolumeSlider").addEventListener('input', (e) => {
    const vol = parseFloat(e.target.value);
    document.getElementById("noiseVolumeValue").textContent = vol.toFixed(2);
    if (noiseGain) {
      noiseGain.gain.setTargetAtTime(vol, audioCtx.currentTime, 0.01);
    }
    saveSettings();
  });

  const ttsSlider = document.getElementById("ttsVolumeSlider");
  ttsSlider.addEventListener('input', (e) => {
    const vol = parseFloat(e.target.value);
    document.getElementById("ttsVolumeValue").textContent = vol.toFixed(2);
    ttsVolume = vol;
    saveSettings();
  });
  ttsSlider.addEventListener('change', () => {
    if ('speechSynthesis' in window) {
      speechSynthesis.cancel();
      speakMessage("éŸ³é‡ãƒ†ã‚¹ãƒˆ", true);
    }
  });

  // â–¼â–¼â–¼ã€ã“ã“ã«è¿½åŠ ã€‘ãƒ–ãƒ©ã‚¦ã‚¶ãƒªãƒ­ãƒ¼ãƒ‰æ™‚ã®TTSã‚­ãƒ£ãƒ³ã‚»ãƒ« â–¼â–¼â–¼
  window.addEventListener('beforeunload', () => {
    // ãƒ–ãƒ©ã‚¦ã‚¶ã®ãƒªãƒ­ãƒ¼ãƒ‰ã‚„ãƒšãƒ¼ã‚¸é›¢è„±æ™‚ã«TTSã‚’å¼·åˆ¶ã‚­ãƒ£ãƒ³ã‚»ãƒ«
    if ('speechSynthesis' in window) {
      speechSynthesis.cancel();
    }
  });
  // â–²â–²â–²ã€è¿½åŠ ã“ã“ã¾ã§ã€‘â–²â–²â–²

  // --- 3. ã‚·ãƒŠãƒªã‚ªèª­ã¿è¾¼ã¿ â†’ åˆæœŸåŒ– â†’ å¸¸ã«è‡ªå‹•èµ·å‹• ---
  try {
    // ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’å®Œå…¨ã«å›é¿ã™ã‚‹ãŸã‚ã®ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ä»˜ã
    const cacheBuster = `v=${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
    const response = await fetch(`scenario.csv?${cacheBuster}`, { 
      cache: 'no-store',
      headers: {
        'Cache-Control': 'no-cache, no-store, must-revalidate',
        'Pragma': 'no-cache'
      }
    });
    
    if (response.ok) {
      const csvText = await response.text();
      initializeSystem(csvText);
      
      // â–¼â–¼â–¼ ã€é‡è¦ã€‘ã‚·ãƒŠãƒªã‚ªèª­ã¿è¾¼ã¿æˆåŠŸå¾Œã€å¿…ãšè‡ªå‹•èµ·å‹• â–¼â–¼â–¼
      if (scenarioEngine) { // â˜…â˜…â˜… initializeSystemãŒæˆåŠŸã—ãŸå ´åˆã®ã¿èµ·å‹• â˜…â˜…â˜…
        console.log('[System] Auto-starting system...');
        updateTimers(); // â† ã“ã“ã«ç§»å‹•ï¼ˆrunSystemã®å‰ï¼‰
        await runSystem();
      }
    } else {
      document.getElementById("caseList").innerHTML =
        '<div class="no-cases">âŒ scenario.csvã®èª­è¾¼ã«å¤±æ•—ã—ã¾ã—ãŸã€‚</div>';
    }
  } catch (fetchError) {
    console.error('[System] Failed to load scenario:', fetchError);
    document.getElementById("caseList").innerHTML =
      '<div class="no-cases">âŒ scenario.csvã®èª­è¾¼ã«å¤±æ•—ã—ã¾ã—ãŸã€‚</div>';
  }
});

document.getElementById("syncBtn").addEventListener("click", () => {
  // â–¼â–¼â–¼ã€è¿½åŠ ã€‘ç¾åœ¨å†ç”Ÿä¸­ã®éŸ³å£°ã‚’ã™ã¹ã¦åœæ­¢ã™ã‚‹ â–¼â–¼â–¼
  if ('speechSynthesis' in window) { speechSynthesis.cancel(); }
  const url = new URL(location.href);
  url.searchParams.set('restart', 'true');   // æ—¢å­˜ã®ã‚¯ã‚¨ãƒªã¯ä¿æŒ
  location.href = url.toString();            // ãƒãƒƒã‚·ãƒ¥(#)ã‚‚ä¿æŒ
});

if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => {
    navigator.serviceWorker.register('./service-worker.js')
      .then(reg => console.log('Service Worker registered'))
      .catch(err => console.log('Service Worker registration failed'));
  });
}

</script>
</body>
</html>